<script>
    // â­ ì—¬ê¸°ì— Makeì—ì„œ ë³µì‚¬í•œ Webhook URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    // í˜•ì‹: https://hook.eu1.make.com/xxxxxxxxxxxxxxx
    const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq"; 
    
    // ë¡œë”© ìƒíƒœ ê´€ë¦¬
    let isSending = false;

    // Helper function to format date as MMDDYYYY
    function formatDate(date) {
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const yyyy = date.getFullYear();
        // ì›¹í›… ì „ì†¡ìš© í˜•ì‹: MMDDYYYY (ê¸°ì¡´ '/' ì œê±°)
        return `${mm}${dd}${yyyy}`; 
    }

    // Helper function to format date for HTML input (YYYY-MM-DD)
    function formatHtmlDate(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${mm}/${dd}/${yyyy}`;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘ì¼(1ë…„ ì „)ê³¼ ì¢…ë£Œì¼(ì˜¤ëŠ˜)ì„ ì„¤ì •
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        // HTML date inputì— YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
        document.getElementById('end-date').value = formatHtmlDate(today);
        document.getElementById('start-date').value = formatHtmlDate(oneYearAgo);
    });

    // Make ì›¹í›…ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
    async function sendMessage() {
        const inputElement = document.getElementById('user-input');
        const selectElement = document.getElementById('preset-prompt');
        const sendButton = document.getElementById('send-button');
        const messagesDiv = document.getElementById('messages');
        
        // --- 1. ìµœì¢… ì§ˆë¬¸ (prompt) ê²°ì • ---
        const presetMessage = selectElement.value;
        const typedMessage = inputElement.value.trim();
        const message = presetMessage || typedMessage;

        // --- 2. ì¶”ê°€ ë°ì´í„° ìˆ˜ì§‘ ë° í˜•ì‹ ë³€ê²½ (MMDDYYYY) ---
        const startDateValue = document.getElementById('start-date').value;
        const endDateValue = document.getElementById('end-date').value;
        
        // HTML ì…ë ¥ê°’(YYYY-MM-DD)ì„ Date ê°ì²´ë¡œ ë³€í™˜
        const startDateObj = startDateValue ? new Date(startDateValue) : null;
        const endDateObj = endDateValue ? new Date(endDateValue) : null;
        
        // ì›¹í›… ì „ì†¡ì„ ìœ„í•´ MMDDYYYY í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const startDate = startDateObj ? formatDate(startDateObj) : '';
        const endDate = endDateObj ? formatDate(endDateObj) : '';
        
        const locationInput = document.getElementById('location-input').value; 
        const itemInput = document.getElementById('item-input').value.trim();
        const itemColorInput = document.getElementById('item-color-input').value.trim(); // Item Color ì¶”ê°€

        // --- 3. ìœ íš¨ì„± ê²€ì‚¬ (alert ì‚¬ìš© ë¶ˆê°€, ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•´ HTML ìš”ì†Œ ì‚¬ìš© ê¶Œì¥) ---
        if (!message || isSending) {
             if (!message && !isSending) {
                 messagesDiv.innerHTML += `<div class="ai-message self-start bg-yellow-100 text-yellow-700">âš ï¸ ì˜¤ë¥˜: ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>`;
                 messagesDiv.scrollTop = messagesDiv.scrollHeight;
             }
             return;
        }
        
        // --- 4. ì „ì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸ ---
        isSending = true;
        sendButton.disabled = true;

        // --- 5. ì‚¬ìš©ì ì§ˆë¬¸ì„ í™”ë©´ì— í‘œì‹œ (í•„í„° ë°ì´í„° í¬í•¨) ---
        let displayMessage = message;
        let filterDetails = [];
        if (startDate) filterDetails.push(`ì‹œì‘ì¼: ${startDate}`);
        if (endDate) filterDetails.push(`ì¢…ë£Œì¼: ${endDate}`);
        
        // Locationì´ ì„ íƒëœ ê²½ìš°ì—ë§Œ í‘œì‹œ (value=""ê°€ 'ëª¨ë‘'ë¥¼ ì˜ë¯¸)
        if (locationInput) filterDetails.push(`Location: ${locationInput}`); 
        
        if (itemInput) filterDetails.push(`Item: ${itemInput}`);
        
        if (itemColorInput) filterDetails.push(`Item Color: ${itemColorInput}`); // Item Color í‘œì‹œ ì¶”ê°€

        if (filterDetails.length > 0) {
            displayMessage += `<br><span class="text-xs opacity-80">(í•„í„°: ${filterDetails.join(', ')})</span>`;
        }

        messagesDiv.innerHTML += `<div class="user-message self-end">${displayMessage}</div>`;
        inputElement.value = ''; 
        selectElement.value = ''; 

        // --- 6. ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ ---
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading';
        loadingDiv.textContent = '... AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
        messagesDiv.appendChild(loadingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 

        try {
            // --- 7. Make Webhookìœ¼ë¡œ ë°ì´í„° ì „ì†¡ (MMDDYYYY í˜•ì‹ìœ¼ë¡œ ì „ì†¡) ---
            const response = await fetch(MAKE_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: message, // Geminiì—ê²Œ ë³´ë‚¼ í•µì‹¬ ì§ˆë¬¸
                    startDate: startDate, // MMDDYYYY
                    endDate: endDate,     // MMDDYYYY
                    location: locationInput,
                    item: itemInput,
                    itemColor: itemColorInput // Item Color ì „ì†¡
                })
            });

            // --- 8. ì‘ë‹µ ì²˜ë¦¬ ---
            const data = await response.json();
            
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const currentLoadingDiv = document.getElementById('loading');
            if (currentLoadingDiv) currentLoadingDiv.remove();

            // 9. Geminiì˜ ë‹µë³€ì„ í™”ë©´ì— í‘œì‹œ
            let responseText = data.response_text || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Make ì‹œë‚˜ë¦¬ì˜¤ì˜ Webhook Response ëª¨ë“ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì›¹í›…ì´ í•„í„° ë°ì´í„°ë¥¼ ì œëŒ€ë¡œ ìˆ˜ì‹ í•˜ëŠ”ì§€ í™•ì¸)";
            
            messagesDiv.innerHTML += `<div class="ai-message self-start">ğŸ¤–: ${responseText}</div>`;
            
        } catch (error) {
            console.error("Fetch Error:", error);
            
            const currentLoadingDiv = document.getElementById('loading');
            if (currentLoadingDiv) currentLoadingDiv.remove();
            
            messagesDiv.innerHTML += `<div class="ai-message self-start bg-red-100 text-red-700">âš ï¸ í†µì‹  ì˜¤ë¥˜ ë°œìƒ: ì›¹í›… URLì„ í™•ì¸í•˜ê±°ë‚˜ Make ì‹œë‚˜ë¦¬ì˜¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
        } finally {
            // 10. ìƒíƒœ ë³µêµ¬
            isSending = false;
            sendButton.disabled = false;
            messagesDiv.scrollTop = messagesDiv.scrollHeight; 
        }
    }
</script>
