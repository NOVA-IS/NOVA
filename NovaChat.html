<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP-AI ì±—ë´‡</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        #messages {
            overflow-y: auto;
        }

        /* GPT ìŠ¤íƒ€ì¼ ì…ë ¥ë°” */
        .gpt-input-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #ffffff;
            border: 1px solid #e5e7eb;   /* gray-200~300 */
            border-radius: 9999px;
            padding: 6px 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        /* ì™¼ìª½ AI ëª¨ë“œ ë²„íŠ¼ (í”„ë¡¬í”„íŠ¸ ì•ˆ) */
        .gpt-left-btn {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            border: none;
            background: #f3f4f6;
            color: #374151;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            padding: 0 8px;
        }

        /* AI ëª¨ë“œ í† ê¸€ í™œì„±í™” ì‹œ */
        .ai-toggle-active {
            background-color: #0284c7 !important; /* sky-700 */
            border-color: #0284c7 !important;
            color: white !important;
        }

        /* ê°€ìš´ë° í”„ë¡¬í”„íŠ¸ ì…ë ¥ì°½ */
        .gpt-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            line-height: 1.4;
            padding: 10px 10px;
            min-height: 44px;
            max-height: 120px;
            background: transparent;
            scrollbar-width: none;
        }
        .gpt-input::-webkit-scrollbar {
            display: none;
        }

        /* ì˜¤ë¥¸ìª½ ì „ì†¡ ë²„íŠ¼ (ì›í˜•) */
        .gpt-send-btn {
            background: #4f46e5;   /* indigo-600 */
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(79,70,229,0.4);
        }
        .gpt-send-btn:disabled {
            background: #9ca3af; /* gray-400 */
            box-shadow: none;
        }

        /* í”„ë¡¬í”„íŠ¸ ì¤„ ì–‘ìª½ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ì§€ê¸ˆì€ ì‚¬ìš© ê±°ì˜ ì•ˆ í•˜ì§€ë§Œ ë‚¨ê²¨ë‘ ) */
        .prompt-bar-btn {
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }

        /* textarea ê¸°ë³¸ ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆ ì œê±° (gpt-inputì—ë„ ì ìš©) */
        textarea {
            scrollbar-width: none;       /* Firefox */
            -ms-overflow-style: none;    /* IE, Edge */
            overflow-y: auto;
            resize: none;
        }
        textarea::-webkit-scrollbar {
            display: none !important;    /* Chrome, Safari */
        }

        /* AI ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .ai-mode-active-textarea {
            background-color: #e0f2fe !important; /* sky-100 */
        }

        /* AI ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ ì „ì†¡ ë²„íŠ¼ ìƒ‰ */
        .ai-mode-active-button {
            background-color: #0284c7 !important; /* sky-700 */
        }

        /* ì˜¤ë¥¸ìª½ ì‚¬ìš©ì ë§í’ì„  */
        .user-message {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 4px 10px rgba(15,23,42,0.18);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* ì™¼ìª½ AI ë§í’ì„  */
        .ai-message {
            background-color: #f3f4f6; /* gray-100 */
            color: #111827;           /* gray-900 */
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            align-self: flex-start;
            margin-right: auto;
            box-shadow: 0 4px 10px rgba(15,23,42,0.10);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        #loading {
            font-size: 0.75rem;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .loading-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6; /* gray-100 */
            color: #4b5563;      /* gray-600 */
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 200px;
            font-size: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .loading-gif {
            width: 24px;
            height: 24px;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ì‚´ì§ ì••ì¶• */
        @media (max-width: 640px) {
            .gpt-input-bar {
                padding: 4px 8px;
                gap: 6px;
            }
            .gpt-left-btn {
                width: 28px;
                height: 28px;
                padding: 0 6px;
            }
            .gpt-send-btn {
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen">

<div class="flex h-screen">

    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <aside class="w-80 bg-white border-r flex flex-col">
        <div class="p-4 border-b">
            <h1 class="text-lg font-bold text-indigo-600">ERP-AI í•„í„°</h1>
            <p class="text-xs text-gray-500 mt-1">
                AI ëª¨ë“œë¥¼ ì„ íƒí•˜ê³ , ERP ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ê°„Â·LocationÂ·Itemì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">

            <!-- AI ë¶„ì„ ëª¨ë“œ (ë§¨ ìœ„, ë¼ë””ì˜¤) -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ë¶„ì„ ëª¨ë“œ</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-mode" value="erp" data-label="ERP-AI ë¶„ì„" checked>
                        <span>ERP-AI ë¶„ì„</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-mode" value="ai" data-label="AI ê²€ìƒ‰">
                        <span>AI ê²€ìƒ‰</span>
                    </label>

                </div>
            </section>

            <!-- ê¸°ê°„ ì„ íƒ (ERP ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) -->
            <section id="period-section">
                <h2 class="text-xs font-semibold text-gray-600 mb-2">ê¸°ê°„ ì„ íƒ</h2>
                <div class="space-y-2">
                    <label class="text-xs">ì‹œì‘ì¼</label>
                    <input type="date" id="start-date"
                           class="w-full p-2 border border-gray-300 rounded-lg">

                    <label class="text-xs">ì¢…ë£Œì¼</label>
                    <input type="date" id="end-date"
                           class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </section>

            <!-- ERP ëª¨ë“œì¼ ë•Œë§Œ ë³´ì´ëŠ”: Location + Item + ì‚¬ìš©ì ì…ë ¥ -->
            <section id="erp-options-section" class="space-y-4">

                <!-- Location -->
                <div id="erp-location-section">
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Location</h2>
                    <div class="p-2 border border-gray-300 rounded-lg space-y-1">

                        <label class="flex items-center space-x-2 font-semibold">
                            <input type="checkbox" id="location-all" class="location-master">
                            <span>ëª¨ë‘ ì„ íƒ</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1007" data-label="SEA">
                            <span>SEA</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1008" data-label="SEG">
                            <span>SEG</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1006" data-label="SEMA">
                            <span>SEMA</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1005" data-label="SEMS">
                            <span>SEMS</span>
                        </label>
                    </div>
                </div>

                <!-- Item + ì‚¬ìš©ì ì…ë ¥ -->
                <div id="erp-item-section" class="space-y-4">
                    <!-- Item -->
                    <div>
                        <h2 class="text-xs font-semibold text-gray-600 mb-2">Item (ì œí’ˆëª…)</h2>
                        <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                            
                            <label class="flex items-center space-x-2 font-semibold">
                                <input type="checkbox" id="item-all" class="item-master">
                                <span>ëª¨ë‘ ì„ íƒ</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="label,Label,LABEL">
                                <span>Label</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="ribbon,Ribbon,RIBBON">
                                <span>Ribbon</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="film,Film,FILM">
                                <span>Film</span>
                            </label>
                        </div>
                    </div>

                    <!-- Item ì‚¬ìš©ì ì…ë ¥ -->
                    <div>
                        <h2 class="text-xs font-semibold text-gray-600 mb-2">Item ì‚¬ìš©ì ì…ë ¥</h2>
                        <input type="text" id="item-color-input"
                            placeholder="ì˜ˆ: Black, White, Strong..."
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <!-- ì—…ì²´ëª… -->
                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">ì—…ì²´ëª…</h2>
                    <input type="text" id="Supplier Name"
                        placeholder="ì˜ˆ: GoPackus"
                        class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                
                <!-- Invoice No -->
                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Invoice No</h2>
                    <input type="text" id="InvoiceNo"
                        placeholder="ì˜ˆ: INV-20231024"
                        class="w-full p-2 border border-gray-300 rounded-lg">
                </div>

            </section>

        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <main class="flex-1 flex flex-col">

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="h-14 px-6 flex items-center border-b bg-white">
            <div>
                <h2 class="text-base font-semibold">NOVA INTEGRATED SOLUTIONS LLC</h2>
                <p class="text-sm text-gray-500">
                    êµ¬ë§¤ì´ë ¥ì„ AI í†µí•´ ì¡°íšŒ ë° ë¶„ì„í•˜ê³  AI ê²€ìƒ‰ì„ ìœ„í•œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ëª¨ë“  ëŒ€í™”ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </p>
            </div>
        </header>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <section id="messages" class="flex-1 flex flex-col p-4 space-y-3 bg-gray-50">
            <div class="ai-message">
                ğŸ¤– ì•ˆë…•í•˜ì„¸ìš”! ì™¼ìª½ì—ì„œ AI ë¶„ì„ ëª¨ë“œë¥¼ ì„ íƒí•œ ë’¤ ì•„ë˜ì— ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.
            </div>
        </section>

        <!-- ì•„ë˜ ì…ë ¥ ì˜ì—­ -->
        <section class="border-t bg-white p-4">
            <div class="max-w-3xl mx-auto space-y-2">

                <!-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ (ERPì¼ ë•Œë§Œ ë³´ì„) -->
                <section id="preset-prompt-wrapper">
                    <select id="preset-prompt"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
                        <option value="">-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ (ì„ íƒ ì•ˆí•¨) --</option>
                        <option value="í•´ë‹¹ ê¸°ê°„ ë° Locationì—ì„œ Taxì™€ Shpping feeë¥¼ ì œì™¸í•˜ê³  ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆ ìˆœìœ„ 10ê°œë¥¼ ìˆœìœ„, itemì´ë¦„, ì´ê¸ˆì•¡, êµ¬ë§¤íšŸìˆ˜ë¡œ ë³´ì—¬ì¤˜">
                            í•´ë‹¹ ê¸°ê°„ ë° Lacationì—ì„œ ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆ ìˆœìœ„ 10ê°œ
                        </option>
                        <option value="ë‹¨ê°€ ë¹„êµë¥¼ ì—…ì²´ëª…, ì•„ì´í…œëª…, ë‹¨ê°€ í‘œë¡œ ì‘ì„±">ë‹¨ê°€ ë¹„êµë¥¼ ì—…ì²´ëª…, ì•„ì´í…œëª…, ë‹¨ê°€ í‘œë¡œ ì‘ì„±</option>
                    </select>
                </section>

                <!-- GPT ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ ë°” -->
                <div class="gpt-input-bar">
                    <!-- ì™¼ìª½: AI ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
                    <button id="ai-search-toggle" class="gpt-left-btn">
                        AIëª¨ë“œ
                    </button>

                    <!-- ê°€ìš´ë°: í”„ë¡¬í”„íŠ¸ textarea -->
                    <textarea id="user-input"
                              placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”"
                              class="gpt-input"
                              rows="1"
                              oninput="autoResize(this)"></textarea>

                    <!-- ì˜¤ë¥¸ìª½: ì „ì†¡ ë²„íŠ¼ -->
                    <button onclick="sendMessage()" id="send-button"
                            class="gpt-send-btn">
                        â¤
                    </button>
                </div>

            </div>
        </section>

    </main>
</div>


<script>
/* textarea ìë™ ë†’ì´ ì¦ê°€ */
function autoResize(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
}

/* ë‚ ì§œ í¬ë§· í•¨ìˆ˜ */
function formatHtmlDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function formatDisplayDate(date) {
    return `${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).
        padStart(2,'0')}/${date.getFullYear()}`;
}
function formatWebhookDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function parseHtmlDate(str) {
    const [y,m,d] = str.split("-");
    return new Date(parseInt(y), parseInt(m)-1, parseInt(d));
}

/* "ëª¨ë‘ ì„ íƒ" ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥ */
function setupMasterCheckbox(masterSelector, itemSelector) {
    const master = document.querySelector(masterSelector);
    const items = document.querySelectorAll(itemSelector);

    if (!master || items.length === 0) return;

    master.addEventListener("change", () => {
        items.forEach(cb => cb.checked = master.checked);
    });

    items.forEach(cb => {
        cb.addEventListener("change", () => {
            const allChecked = Array.from(items).every(x => x.checked);
            master.checked = allChecked;
        });
    });
}

/* í˜„ì¬ ì„ íƒëœ AI ëª¨ë“œ ê°’ ê°€ì ¸ì˜¤ê¸° */
function getCurrentAiMode() {
    const selected = document.querySelector('input[name="ai-mode"]:checked');
    return selected ? selected.value : null;
}

/* ERP ì„ íƒ ì‹œ: ê¸°ê°„ + Location + Item + ë¯¸ë¦¬ì •ì˜ ì§ˆë¬¸ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° */
function updateErpVisibility() {
    const mode = getCurrentAiMode();
    const isErp = (mode === 'erp');

    const periodSection = document.getElementById('period-section');
    const erpOptionsSection = document.getElementById('erp-options-section');
    const presetWrapper = document.getElementById('preset-prompt-wrapper');

    [periodSection, erpOptionsSection, presetWrapper].forEach(el => {
        if (!el) return;
        if (isErp) el.classList.remove('hidden');
        else el.classList.add('hidden');
    });
}

function updateAiModeStyling() {
    const aiMode = getCurrentAiMode();
    const textarea = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");

    if (aiMode === "ai") {
        textarea.classList.add("ai-mode-active-textarea");
        sendButton.classList.add("ai-mode-active-button");
    } else {
        textarea.classList.remove("ai-mode-active-textarea");
        sendButton.classList.remove("ai-mode-active-button");
    }
}

/* ERP/AI ì„ íƒ ì‹œ: í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” */
function resetPromptArea() {
    const textarea = document.getElementById("user-input");
    if (textarea) {
        textarea.value = "";
        autoResize(textarea);
    }
}

/* í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” */
document.addEventListener("DOMContentLoaded", () => {
    const today = new Date();

    // ì¢…ë£Œì¼ = ì˜¤ëŠ˜
    document.getElementById("end-date").value = formatHtmlDate(today);

    // ì‹œì‘ì¼ = ì¢…ë£Œì¼ ê¸°ì¤€ 3ê°œì›” ì „
    const start = new Date(today);
    start.setMonth(start.getMonth() - 3);
    document.getElementById("start-date").value = formatHtmlDate(start);

    setupMasterCheckbox("#location-all", ".location-checkbox");
    setupMasterCheckbox("#item-all", ".item-checkbox");

    // ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ ì‹œ textareaì— ìë™ ì…ë ¥
    const presetSelect = document.getElementById("preset-prompt");
    const userInput = document.getElementById("user-input");

    if (presetSelect && userInput) {
        presetSelect.addEventListener("change", () => {
            const value = presetSelect.value || "";
            userInput.value = value;
            autoResize(userInput);
        });
    }

    // GPT ìŠ¤íƒ€ì¼: Enter â†’ ì „ì†¡, Shift+Enter â†’ ì¤„ë°”ê¿ˆ
    if (userInput) {
        userInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                if (!e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            }
        });
    }

    // í”„ë¡¬í”„íŠ¸ ì˜† AI ê²€ìƒ‰ í† ê¸€ ë²„íŠ¼ & ë¼ë””ì˜¤ ë™ê¸°í™”
    const aiToggleBtn = document.getElementById('ai-search-toggle');
    const aiRadios = document.querySelectorAll('input[name="ai-mode"]');

    if (aiToggleBtn) {
        // í† ê¸€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¼ë””ì˜¤ë„ ê°™ì´ ë°”ë€œ
        aiToggleBtn.addEventListener('click', () => {
            const isActive = aiToggleBtn.classList.toggle('ai-toggle-active'); // on/off

            const targetValue = isActive ? 'ai' : 'erp';
            const targetRadio = document.querySelector(
                `input[name="ai-mode"][value="${targetValue}"]`
            );
            if (targetRadio) {
                targetRadio.checked = true;
            }

            updateErpVisibility();
            updateAiModeStyling();
            resetPromptArea();
        });

        // ë¼ë””ì˜¤ë¥¼ ë°”ê¾¸ë©´ í† ê¸€ ìƒíƒœë„ ë”°ë¼ê°
        aiRadios.forEach(r => {
            r.addEventListener('change', () => {
                const isAi = r.value === 'ai' && r.checked;
                if (isAi) {
                    aiToggleBtn.classList.add('ai-toggle-active');
                } else {
                    aiToggleBtn.classList.remove('ai-toggle-active');
                }

                updateErpVisibility();
                updateAiModeStyling();
                resetPromptArea();
            });
        });
    }

    // ì´ˆê¸° í‘œì‹œ ìƒíƒœ
    updateErpVisibility();
    updateAiModeStyling();
    autoResize(userInput);
});

/* ì „ì†¡ ë¡œì§ */
const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq";
let isSending = false;

async function sendMessage() {
    const textarea = document.getElementById("user-input");
    const selectElement = document.getElementById("preset-prompt");
    const sendButton = document.getElementById("send-button");
    const messagesDiv = document.getElementById("messages");

    // í”„ë¡¬í”„íŠ¸ ì°½ ë‚´ìš©ë§Œ ì „ì†¡
    const message = textarea.value.trim();

    if (!message || isSending) {
        if (!message && !isSending) {
            messagesDiv.innerHTML += `<div class="ai-message self-start bg-yellow-100 text-yellow-700">âš ï¸ ì˜¤ë¥˜: ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        return;
    }

    // ë‚ ì§œ
    const startDateObj = parseHtmlDate(document.getElementById("start-date").value);
    const endDateObj = parseHtmlDate(document.getElementById("end-date").value);

    const startDateDisplay = formatDisplayDate(startDateObj);
    const endDateDisplay = formatDisplayDate(endDateObj);
    const startDateForWebhook = formatWebhookDate(startDateObj);
    const endDateForWebhook = formatWebhookDate(endDateObj);

    // Location
    const locBoxes = document.querySelectorAll(".location-checkbox:checked");
    const locationIds = Array.from(locBoxes).map(cb => cb.value);
    const locationLabels = Array.from(locBoxes).map(cb => cb.dataset.label);

    // Item
    const itemBoxes = document.querySelectorAll(".item-checkbox:checked");
    const itemIds = Array.from(itemBoxes).map(cb => cb.value);
    const itemLabel = itemIds.join(", ");

    // Item ì‚¬ìš©ì ì…ë ¥
    const itemColor = document.getElementById("item-color-input").value.trim();

    // AI ëª¨ë“œ (ë¼ë””ì˜¤)
    const aiRadio = document.querySelector('input[name="ai-mode"]:checked');
    const aiMode = aiRadio ? aiRadio.value : null;
    const aiModeLabel = aiRadio ? aiRadio.dataset.label : "";

    // ERP ì„ íƒ ì‹œ: Item ë˜ëŠ” ì‚¬ìš©ì ì…ë ¥ í•„ìˆ˜
    if (aiMode === 'erp' && itemIds.length === 0 && !itemColor) {
        messagesDiv.innerHTML += `
            <div class="ai-message self-start bg-yellow-100 text-yellow-700">
                âš ï¸ ERP ë¶„ì„ì„ ì„ íƒí•œ ê²½ìš°, ìµœì†Œ í•˜ë‚˜ì˜ ì œí’ˆëª… ë˜ëŠ” Item ì‚¬ìš©ì ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return;
    }

    isSending = true;
    sendButton.disabled = true;

    // í™”ë©´ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
    let filterTxt = [];
    if (aiModeLabel) filterTxt.push(`AI ëª¨ë“œ: ${aiModeLabel}`);
    if (aiMode === 'erp') {
        if (startDateDisplay) filterTxt.push(`ì‹œì‘ì¼: ${startDateDisplay}`);
        if (endDateDisplay) filterTxt.push(`ì¢…ë£Œì¼: ${endDateDisplay}`);
        if (locationLabels.length) filterTxt.push(`Location: ${locationLabels.join(", ")}`);
        if (itemLabel) filterTxt.push(`Item: ${itemLabel}`);
        if (itemColor) filterTxt.push(`Item ì‚¬ìš©ì ì…ë ¥: ${itemColor}`);
    }

    messagesDiv.innerHTML += `
        <div class="user-message">
            ${message}
            ${filterTxt.length ? `<br><span class="text-xs opacity-80">(í•„í„°: ${filterTxt.join(", ")})</span>` : ""}
        </div>`;

    textarea.value = "";
    autoResize(textarea);
    if (!document.getElementById('preset-prompt-wrapper').classList.contains('hidden')) {
        selectElement.value = "";
    }

    const loadingDiv = document.createElement("div");
    loadingDiv.id = "loading";
    loadingDiv.innerHTML = `
        <div class="loading-bubble">
            <img src="https://i.gifer.com/ZZ5H.gif" class="loading-gif" />
            <span>AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>
        </div>
    `;
    messagesDiv.appendChild(loadingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
        const body = {
            prompt: message,
            startDate: startDateForWebhook,
            endDate: endDateForWebhook,
            location: locationIds.join(","),
            locationIds,
            locationLabels,
            item: itemLabel,
            itemIds,
            itemColor,
            aiMode,
            aiModeLabel
        };

        const response = await fetch(MAKE_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const rawText = await response.text();

        if (!response.ok) {
            throw new Error(`HTTP ${response.status} ${response.statusText} / body: ${rawText}`);
        }

        loadingDiv.remove();

        messagesDiv.innerHTML += `
            <div class="ai-message">ğŸ¤–: ${rawText}</div>
        `;

    } catch (err) {
        loadingDiv.remove();

        console.error("ì›¹í›… í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);

        const msg = (err && err.message ? err.message : String(err))
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        messagesDiv.innerHTML += `
            <div class="ai-message bg-red-100 text-red-700 text-sm">
                âš ï¸ í†µì‹  ì˜¤ë¥˜: ${msg}
            </div>
        `;
    }

    isSending = false;
    sendButton.disabled = false;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>

</body>
</html>
