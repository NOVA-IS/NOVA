<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP-Gemini ì±—ë´‡</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* ì‚¬ìš©ì ì •ì˜ ìŠ¤íƒ€ì¼ */
        #messages {
            height: 55vh; /* ë†’ì´ë¥¼ ì¤„ì—¬ì„œ ì…ë ¥ í•„ë“œ ê³µê°„ í™•ë³´ */
            overflow-y: auto;
            border-bottom: 1px solid #e5e7eb;
        }
        .user-message {
            @apply bg-indigo-500 text-white p-3 rounded-lg shadow-md mb-2 max-w-3/4 self-end ml-auto; 
        }
        .ai-message {
            @apply bg-gray-100 text-gray-800 p-3 rounded-lg shadow-md mb-2 max-w-3/4 self-start mr-auto; 
        }
        #loading {
            @apply text-sm text-gray-500 italic mb-2;
        }
        /* ë‚ ì§œ í•„ë“œì™€ ë ˆì´ë¸”ì„ ë¬¶ëŠ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .input-group-container {
            @apply flex flex-col space-y-1;
        }
        .input-label {
            @apply text-xs font-semibold text-gray-600;
        }
        /* Location, Item ë“± ë ˆì´ë¸”ì„ ì œê±°í•œ ì…ë ¥ í•„ë“œì˜ ìŠ¤íƒ€ì¼ ì¡°ì • */
        .input-field-no-label {
            @apply flex flex-col justify-end;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans flex items-center justify-center min-h-screen p-4">

<div id="chat-container" class="w-full max-w-3xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh]">
    <header class="p-4 border-b bg-indigo-600 text-white rounded-t-xl">
        <h1 class="text-xl font-bold">ERP-Gemini ì±—ë´‡</h1>
        <p class="text-sm">ë°ì´í„° í•„í„°ë¥¼ ìœ„í•œ ì¶”ê°€ ì…ë ¥ í•„ë“œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</p>
    </header>

    <!-- ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->
    <div id="messages" class="flex flex-col p-4 space-y-3 flex-grow">
        <div class="ai-message">
            ğŸ¤– ì•ˆë…•í•˜ì„¸ìš”! ëª¨ë“  ì…ë ¥ í•„ë“œ(ë‚ ì§œ, Location, Item)ì™€ ì§ˆë¬¸ì„ í•¨ê»˜ ì…ë ¥í•˜ì—¬ ë¬¸ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>

    <!-- ì…ë ¥ ë° ì „ì†¡ ì˜ì—­ -->
    <div class="p-4 border-t border-gray-200 flex flex-col space-y-3">
        
        <!-- ë°ì´í„° í•„í„° ì…ë ¥ í•„ë“œ -->
        <div class="flex flex-col space-y-3">
            
            <!-- ROW 1: ì‹œì‘ì¼ / ì¢…ë£Œì¼ (ê°€ìš´ë° ì •ë ¬) -->
            <div class="flex justify-center">
                <div class="grid grid-cols-2 gap-3 w-full max-w-md">
                    
                    <!-- ì‹œì‘ì¼ í•„ë“œ (MM/DD/YYYY í…ìŠ¤íŠ¸) -->
                    <div class="input-group-container">
                        <label for="start-date" class="input-label">ì‹œì‘ì¼</label>
                        <input type="text" id="start-date"
                               class="p-2 border border-gray-300 rounded-lg"
                               title="ì‹œì‘ì¼"
                               placeholder="MM/DD/YYYY">
                    </div>
                    
                    <!-- ì¢…ë£Œì¼ í•„ë“œ (MM/DD/YYYY í…ìŠ¤íŠ¸) -->
                    <div class="input-group-container">
                        <label for="end-date" class="input-label">ì¢…ë£Œì¼</label>
                        <input type="text" id="end-date"
                               class="p-2 border border-gray-300 rounded-lg"
                               title="ì¢…ë£Œì¼"
                               placeholder="MM/DD/YYYY">
                    </div>
                </div>
            </div>

            <!-- ROW 2: Location / Item / Item Color -->
            <div class="grid grid-cols-3 gap-3">
                
                <!-- Location (ë ˆì´ë¸” ì œê±°) -->
                <div class="input-field-no-label">
                    <select id="location-input" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Location">
                        <option value="">-- Location ì„ íƒ --</option>
                        <option value="">ëª¨ë‘</option>
                        <option value="1007">SEA</option>
                        <option value="1008">SEG</option>
                        <option value="1006">SEMA</option>
                        <option value="1005">SEMS</option>
                    </select>
                </div>

                <!-- Item (ì œí’ˆëª…) ì…€ë ‰íŠ¸ ë°•ìŠ¤ë¡œ ë³€ê²½: Label / ì—¬ëŸ¬ ID -->
                <div class="input-field-no-label">
                    <select id="item-input" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Item (ì œí’ˆëª…)">
                        <option value="">-- Item ì„ íƒ --</option>
                        <!-- valueì— ì—¬ëŸ¬ IDë¥¼ ì½¤ë§ˆë¡œ ë„£ê³ , í™”ë©´ì—ëŠ” Labelì´ ë³´ì´ê²Œ -->
                        <option value="label">Label</option>
                        <option value="Ribbon">Ribbon</option>
                        <option value="Film">Film</option>
                        <!-- ì‹¤ì œ ì‚¬ìš© ì‹œ, ìœ„ ì˜µì…˜ë“¤ì„ í•„ìš”í•œ ìƒí’ˆ Label/IDë¡œ êµì²´í•´ì„œ ì‚¬ìš© -->
                    </select>
                </div>
                
                <!-- Item Color (ì œí’ˆ ìƒ‰ìƒ) (ë ˆì´ë¸” ì œê±°) -->
                <div class="input-field-no-label">
                    <input type="text" id="item-color-input" placeholder="Item Color (ì œí’ˆ ìƒ‰ìƒ)" class="p-2 border border-gray-300 rounded-lg" title="Item Color (ì œí’ˆ ìƒ‰ìƒ)">
                </div>
            </div>
        </div>
        
        <!-- ROW 3: í”„ë¡¬í”„íŠ¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <select id="preset-prompt" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ (ì„ íƒ ì•ˆí•¨) --</option>
            <option value="í•´ë‹¹ ê¸°ê°„ ë° ì§€ì—­ì—ì„œ ê°€ì¥ ë§ì´ íŒ”ë¦° ì œí’ˆì€?">í•´ë‹¹ ê¸°ê°„ ë° ì§€ì—­ì—ì„œ ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆì€?</option>
            <option value="ì—…ì²´ë³„ ë‹¨ê°€ ë¹„êµ í‘œ ì‘ì„±">ì—…ì²´ë³„ ë‹¨ê°€ ë¹„êµ í‘œ ì‘ì„±</option>
        </select>
        
        <!-- ROW 4: ì‚¬ìš©ì ì…ë ¥ ë° ì „ì†¡ ë²„íŠ¼ -->
        <div class="flex space-x-3">
            <input type="text" id="user-input" placeholder="ë˜ëŠ” ì—¬ê¸°ì— ì§ì ‘ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   onkeypress="if(event.keyCode === 13) sendMessage()">
            <button onclick="sendMessage()" id="send-button"
                    class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-gray-400">
                ì „ì†¡
            </button>
        </div>
    </div>
</div>

<script>
    // â­ ì—¬ê¸°ì— Makeì—ì„œ ë³µì‚¬í•œ Webhook URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq"; 
    
    // ë¡œë”© ìƒíƒœ ê´€ë¦¬
    let isSending = false;

    // UIì— ë³´ì´ëŠ” ë‚ ì§œ í˜•ì‹: MM/DD/YYYY
    function formatUIDate(date) {
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${mm}/${dd}/${yyyy}`;
    }

    // ì›¹í›… ì „ì†¡ìš© ë‚ ì§œ í˜•ì‹: MMDDYYYY
    function formatWebhookDate(date) {
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${mm}${dd}${yyyy}`;
    }

    // "MM/DD/YYYY" ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
    function parseUIDate(str) {
        if (!str) return null;
        const parts = str.split('/');
        if (parts.length !== 3) return null;
        const [mm, dd, yyyy] = parts;
        const month = parseInt(mm, 10);
        const day = parseInt(dd, 10);
        const year = parseInt(yyyy, 10);
        if (!month || !day || !year) return null;
        // ì›”(day)-ë²”ìœ„ ì²´í¬ ì •ë„ë§Œ ê°„ë‹¨íˆ
        return new Date(year, month - 1, day);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘ì¼(1ë…„ ì „)ê³¼ ì¢…ë£Œì¼(ì˜¤ëŠ˜)ì„ UI í˜•ì‹(MM/DD/YYYY)ìœ¼ë¡œ ì„¤ì •
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        document.getElementById('end-date').value = formatUIDate(today);
        document.getElementById('start-date').value = formatUIDate(oneYearAgo);
    });

    // Make ì›¹í›…ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
    async function sendMessage() {
        const inputElement = document.getElementById('user-input');
        const selectElement = document.getElementById('preset-prompt');
        const sendButton = document.getElementById('send-button');
        const messagesDiv = document.getElementById('messages');
        
        // --- 1. ìµœì¢… ì§ˆë¬¸ (prompt) ê²°ì • ---
        const presetMessage = selectElement.value;
        const typedMessage = inputElement.value.trim();
        const message = presetMessage || typedMessage;

        // --- 2. ì¶”ê°€ ë°ì´í„° ìˆ˜ì§‘ ---
        const startDateStr = document.getElementById('start-date').value.trim();
        const endDateStr = document.getElementById('end-date').value.trim();
        
        const startDateObj = parseUIDate(startDateStr);
        const endDateObj = parseUIDate(endDateStr);

        // ì›¹í›… ì „ì†¡ìš©: MMDDYYYY ë¡œ ë³€í™˜
        const startDateForWebhook = startDateObj ? formatWebhookDate(startDateObj) : '';
        const endDateForWebhook = endDateObj ? formatWebhookDate(endDateObj) : '';

        const locationInput = document.getElementById('location-input').value; 
        
        // Itemì€ select ê¸°ë°˜ (Label + ì—¬ëŸ¬ ID)
        const itemSelect = document.getElementById('item-input');
        const selectedItemOption = itemSelect.options[itemSelect.selectedIndex];
        const itemLabel = selectedItemOption && selectedItemOption.value !== "" ? selectedItemOption.text : '';
        const itemIds = selectedItemOption && selectedItemOption.value !== "" 
            ? selectedItemOption.value.split(',').map(id => id.trim()).filter(Boolean)
            : [];

        const itemColorInput = document.getElementById('item-color-input').value.trim();

        // --- 3. ìœ íš¨ì„± ê²€ì‚¬ ---
        if (!message || isSending) {
             if (!message && !isSending) {
                 messagesDiv.innerHTML += `<div class="ai-message self-start bg-yellow-100 text-yellow-700">âš ï¸ ì˜¤ë¥˜: ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>`;
                 messagesDiv.scrollTop = messagesDiv.scrollHeight;
             }
             return;
        }
        
        // --- 4. ì „ì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸ ---
        isSending = true;
        sendButton.disabled = true;

        // --- 5. ì‚¬ìš©ì ì§ˆë¬¸ì„ í™”ë©´ì— í‘œì‹œ (í•„í„° ë°ì´í„° í¬í•¨) ---
        let displayMessage = message;
        let filterDetails = [];
        if (startDateStr) filterDetails.push(`ì‹œì‘ì¼: ${startDateStr}`);
        if (endDateStr) filterDetails.push(`ì¢…ë£Œì¼: ${endDateStr}`);
        
        // Locationì´ ì„ íƒëœ ê²½ìš°ì—ë§Œ í‘œì‹œ (value=""ê°€ 'ëª¨ë‘'ë¥¼ ì˜ë¯¸)
        if (locationInput) filterDetails.push(`Location: ${locationInput}`); 
        
        if (itemLabel) filterDetails.push(`Item: ${itemLabel} (${itemIds.join(', ')})`);
        
        if (itemColorInput) filterDetails.push(`Item Color: ${itemColorInput}`);

        if (filterDetails.length > 0) {
            displayMessage += `<br><span class="text-xs opacity-80">(í•„í„°: ${filterDetails.join(', ')})</span>`;
        }

        messagesDiv.innerHTML += `<div class="user-message self-end">${displayMessage}</div>`;
        inputElement.value = ''; 
        selectElement.value = ''; 

        // --- 6. ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ ---
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading';
        loadingDiv.textContent = '... AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
        messagesDiv.appendChild(loadingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 

        try {
            // --- 7. Make Webhookìœ¼ë¡œ ë°ì´í„° ì „ì†¡ (ë‚ ì§œëŠ” MMDDYYYY) ---
            const response = await fetch(MAKE_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: message,            // Geminiì—ê²Œ ë³´ë‚¼ í•µì‹¬ ì§ˆë¬¸
                    startDate: startDateForWebhook, // MMDDYYYY
                    endDate: endDateForWebhook,     // MMDDYYYY
                    location: locationInput,
                    item: itemLabel,               // ê¸°ì¡´ í˜¸í™˜ìš©: Label
                    itemLabel: itemLabel,          // ëª…ì‹œì ìœ¼ë¡œ Label
                    itemIds: itemIds,              // ì—¬ëŸ¬ ê°œ ID ë°°ì—´ë¡œ ì „ì†¡
                    itemColor: itemColorInput
                })
            });

            // --- 8. ì‘ë‹µ ì²˜ë¦¬ ---
            const data = await response.json();
            
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const currentLoadingDiv = document.getElementById('loading');
            if (currentLoadingDiv) currentLoadingDiv.remove();

            // 9. Geminiì˜ ë‹µë³€ì„ í™”ë©´ì— í‘œì‹œ
            let responseText = data.response_text || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Make ì‹œë‚˜ë¦¬ì˜¤ì˜ Webhook Response ëª¨ë“ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì›¹í›…ì´ í•„í„° ë°ì´í„°ë¥¼ ì œëŒ€ë¡œ ìˆ˜ì‹ í•˜ëŠ”ì§€ í™•ì¸)";
            
            messagesDiv.innerHTML += `<div class="ai-message self-start">ğŸ¤–: ${responseText}</div>`;
            
        } catch (error) {
            console.error("Fetch Error:", error);
            
            const currentLoadingDiv = document.getElementById('loading');
            if (currentLoadingDiv) currentLoadingDiv.remove();
            
            messagesDiv.innerHTML += `<div class="ai-message self-start bg-red-100 text-red-700">âš ï¸ í†µì‹  ì˜¤ë¥˜ ë°œìƒ: ì›¹í›… URLì„ í™•ì¸í•˜ê±°ë‚˜ Make ì‹œë‚˜ë¦¬ì˜¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
        } finally {
            // 10. ìƒíƒœ ë³µêµ¬
            isSending = false;
            sendButton.disabled = false;
            messagesDiv.scrollTop = messagesDiv.scrollHeight; 
        }
    }
</script>

</body>
</html>
