<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/three-dots@0.3.2/dist/three-dots.min.css">
    <title>ERP-AI ì±—ë´‡</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        #messages {
            overflow-y: auto;
        }

        /* GPT ìŠ¤íƒ€ì¼ ì…ë ¥ë°” */
        .gpt-input-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #ffffff;
            border: 1px solid #e5e7eb;  /* gray-200~300 */
            border-radius: 9999px;
            padding: 6px 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        /* ì™¼ìª½ AI ëª¨ë“œ ë²„íŠ¼ (í”„ë¡¬í”„íŠ¸ ì•ˆ) */
        .gpt-left-btn {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            border: none;
            background: #f3f4f6;
            color: #374151;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            padding: 0 8px;
        }

        /* AI ëª¨ë“œ í† ê¸€ í™œì„±í™” ì‹œ */
        .ai-toggle-active {
            background-color: #0284c7 !important; /* sky-700 */
            border-color: #0284c7 !important;
            color: white !important;
        }

        /* ê°€ìš´ë° í”„ë¡¬í”„íŠ¸ ì…ë ¥ì°½ */
        .gpt-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            line-height: 1.4;
            padding: 10px 10px;
            min-height: 44px;
            max-height: 120px;
            background: transparent;
            scrollbar-width: none;
        }
        .gpt-input::-webkit-scrollbar {
            display: none;
        }

        /* ì˜¤ë¥¸ìª½ ì „ì†¡ ë²„íŠ¼ (ì›í˜•) */
        .gpt-send-btn {
            background: #4f46e5;    /* indigo-600 */
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(79,70,229,0.4);
        }
        .gpt-send-btn:disabled {
            background: #9ca3af; /* gray-400 */
            box-shadow: none;
        }

        /* í”„ë¡¬í”„íŠ¸ ì¤„ ì–‘ìª½ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ì§€ê¸ˆì€ ì‚¬ìš© ê±°ì˜ ì•ˆ í•˜ì§€ë§Œ ë‚¨ê²¨ë‘ ) */
        .prompt-bar-btn {
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }

        /* textarea ê¸°ë³¸ ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆ ì œê±° (gpt-inputì—ë„ ì ìš©) */
        textarea {
            scrollbar-width: none;      /* Firefox */
            -ms-overflow-style: none;   /* IE, Edge */
            overflow-y: auto;
            resize: none;
        }
        textarea::-webkit-scrollbar {
            display: none !important;   /* Chrome, Safari */
        }

        /* AI ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .ai-mode-active-textarea {
            background-color: #e0f2fe !important; /* sky-100 */
        }

        /* AI ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ ì „ì†¡ ë²„íŠ¼ ìƒ‰ */
        .ai-mode-active-button {
            background-color: #0284c7 !important; /* sky-700 */
        }

        /* ì˜¤ë¥¸ìª½ ì‚¬ìš©ì ë§í’ì„  */
        .user-message {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 4px 10px rgba(15,23,42,0.18);
            font-size: 0.875rem;
            line-height: 1.5;
            position: relative;
            padding-right: 2.75rem;
        }

        .message-text {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message-meta {
            display: block;
            margin-top: 6px;
            font-size: 0.75rem;
            opacity: 0.85;
        }

        .message-edit-btn {
            position: absolute;
            top: 8px;
            right: 10px;
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255,255,255,0.18);
            color: #ffffff;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .message-edit-btn:hover {
            background: rgba(255,255,255,0.28);
            transform: translateY(-1px);
        }

        /* ì™¼ìª½ AI ë§í’ì„  */
        .ai-message {
            /*background-color: #f3f4f6; /* gray-100 */
            /*color: #111827;           /* gray-900 */
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin: 10px 10px;
            max-width: 100%;
            align-self: flex-start;
            /*margin-right: auto;*/
            /*box-shadow: 0 4px 10px rgba(15,23,42,0.10);*/
            font-size: 0.875rem;
            line-height: 1.5;
        }

        #loading {
            font-size: 0.75rem;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .loading-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6; /* gray-100 */
            color: #4b5563;       /* gray-600 */
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 200px;
            font-size: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .loading-gif {
            width: 24px;
            height: 24px;
        }

        /* íŒŒì¼ì²¨ë¶€ìš© */
        .thumb {
          width: 56px;
          height: 56px;
          border-radius: 12px;
          object-fit: cover;
          border: 1px solid #e5e7eb;
        }
        .thumb-wrap {
          position: relative;
          display: inline-block;
          /* ì´ë¯¸ì§€ ì™¸ íŒŒì¼ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€ */
          min-width: 56px;
          min-height: 56px;
          padding: 8px;
          background: #f9fafb; /* gray-50 */
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-direction: column;
        }
        .thumb-remove {
          position: absolute;
          top: -8px;
          right: -8px;
          width: 22px;
          height: 22px;
          border-radius: 9999px;
          border: 1px solid #e5e7eb;
          background: #fff;
          font-size: 12px;
          line-height: 20px;
          text-align: center;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        .drop-hint {
          outline: 2px dashed rgba(99,102,241,0.55);
          outline-offset: 4px;
        }
        .msg-attachments {
          margin-top: 8px;
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
        }
        
        .msg-attachments img {
          width: 64px;
          height: 64px;
          border-radius: 12px;
          object-fit: cover;
          border: 1px solid rgba(255,255,255,0.35); /* user bubble ëŒ€ë¹„ */
        }

        
        /* ìƒˆë¡­ê²Œ ì¶”ê°€*/
        .stage {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 32px 0;
            margin: 0;
            overflow: hidden;
        }

        .dot-floating {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-floating 3s infinite cubic-bezier(0.15, 0.6, 0.9, 0.1);
        }
        @keyframes dot-floating {
            0% { left: calc(-50% - 5px); }
            75% { left: calc(50% + 105px); }
            100% { left: calc(50% + 105px); }
        }
        @use 'three-dots';

        /* ëª¨ë°”ì¼ì—ì„œ ì‚´ì§ ì••ì¶• */
        @media (max-width: 640px) {
            .gpt-input-bar {
                padding: 4px 8px;
                gap: 6px;
            }
            .gpt-left-btn {
                width: 28px;
                height: 28px;
                padding: 0 6px;
            }
            .gpt-send-btn {
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen">

<div class="flex h-screen">

    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <aside class="w-80 bg-white border-r flex flex-col">
        <div class="p-4 border-b">
            <h1 class="text-lg font-bold text-indigo-600">ERP-AI í•„í„°</h1>
            <p class="text-xs text-gray-500 mt-1">
                ERP ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ê°„, Location, Item, ì—…ì²´ëª…ì„ í†µí•´ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ì—¬ ê·¸ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ AIë¶„ì„ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">
            <!-- ğŸ”¹ AI ì—”ì§„ ì„ íƒ (GPT / Gemini ë“±) -->
<section class="mb-3">
    <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ì—”ì§„ ì„ íƒ</h2>
    <div class="p-2 border border-gray-300 rounded-lg space-y-2">
        <label class="flex items-center space-x-2">
            <input type="radio" name="ai-engine" value="gemini" data-label="Gemini" checked>
            <span>Gemini</span>
        </label>
        <label class="flex items-center space-x-2">
            <input type="radio" name="ai-engine" value="gpt" data-label="GPT" >
            <span>GPT</span>
        </label>
        <!-- í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— í™•ì¥ -->
        <!--
        <label class="flex items-center space-x-2">
            <input type="radio" name="ai-engine" value="claude" data-label="Claude">
            <span>Claude</span>
        </label>
        -->
    </div>
</section>


            <!-- AI ë¶„ì„ ëª¨ë“œ (ë§¨ ìœ„, ë¼ë””ì˜¤) -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ë¶„ì„ ëª¨ë“œ</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-mode" value="erp" data-label="ERP-AI ë¶„ì„" checked>
                        <span>ERP-AI ë¶„ì„</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-mode" value="ai" data-label="AI ê²€ìƒ‰">
                        <span>AI ê²€ìƒ‰</span>
                    </label>

                </div>
            </section>

            <!-- ê¸°ê°„ ì„ íƒ (ERP ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) -->
            <section id="period-section">

                <h2 class="text-xs font-semibold text-gray-600 mb-2">ê¸°ê°„ ì„ íƒ</h2>
                <div class="space-y-2">
                    <label class="text-xs">ì‹œì‘ì¼(ERP ë°ì´í„°: 2024-04-01 ë¶€í„°)</label>
                    <input type="date" id="start-date"
                           class="w-full p-2 border border-gray-300 rounded-lg">

                    <label class="text-xs">ì¢…ë£Œì¼</label>
                    <input type="date" id="end-date"
                           class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <!-- ERP ë‚ ì§œ í”„ë¦°íŠ¸ -->
                <p id="sheet-update-display"
                   class="text-xs text-gray-600 mb-1 text-center leading-relaxed whitespace-pre-line">
                </p>

            </section>

            <!-- ERP ëª¨ë“œì¼ ë•Œë§Œ ë³´ì´ëŠ”: Location + Item + ì‚¬ìš©ì ì…ë ¥ -->
            <section id="erp-options-section" class="space-y-4">

                <!-- Location -->
                <div id="erp-location-section">
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Location</h2>
                    <div class="p-2 border border-gray-300 rounded-lg space-y-1">

                        <label class="flex items-center space-x-2 font-semibold">
                            <input type="checkbox" id="location-all" class="location-master">
                            <span>ëª¨ë‘ ì„ íƒ</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1007" data-label="SEA">
                            <span>SEA</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1008" data-label="SEG">
                            <span>SEG</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1006" data-label="SEMA">
                            <span>SEMA</span>
                        </label>

                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1005" data-label="SEMS">
                            <span>SEMS</span>
                        </label>
                    </div>
                </div>

                <!-- Item + ì‚¬ìš©ì ì…ë ¥ -->
                <div id="erp-item-section" class="space-y-4">
                    <!-- Item -->
                    <div>
                        <h2 class="text-xs font-semibold text-gray-600 mb-2">Item (ì œí’ˆëª…,ì œí’ˆì†ì„±)</h2>
                        <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                            
                            <label class="flex items-center space-x-2 font-semibold">
                            <input type="checkbox" id="item-all" class="item-master">
                            <span>ëª¨ë‘ ì„ íƒ</span>
                        </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="LABEL">
                                <span>Label</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="RIBBON">
                                <span>Ribbon</span>
                            </label>

                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="FILM">
                                <span>Film</span>
                            </label>
                             <!-- ì‚¬ìš©ì ì…ë ¥ ì²´í¬ë°•ìŠ¤ + ì…ë ¥ì°½ -->
                            <div class="space-y-1 pt-1">
                            <!-- ì²´í¬ë°•ìŠ¤ ë¼ë²¨ -->
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="item-custom-toggle">
                                <span><input type="text" id="item-color-input"
                                        placeholder="ì—¬ëŸ¬ê°’ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„"
                                        class="w-full p-2 border border-gray-300 rounded-lg"></span>
                            </label>
                                
                            </div>
                        </div>

                    </div>

                    <!-- Item ì‚¬ìš©ì ì…ë ¥ -->
                    <!--div>
                        <h2 class="text-xs font-semibold text-gray-600 mb-2">Item ì‚¬ìš©ì ì…ë ¥</h2>
                        <input type="text" id="item-color-input"
                            placeholder="ì—¬ëŸ¬ê°’ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„"
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div-->
                </div>
                <!-- í”„ë¡œì íŠ¸ -->
                <div class="relative">
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Project</h2>
                    <!-- ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ -->
                    <button id="projectDropdownBtn"
                            class="w-full p-2 border border-gray-300 rounded-lg flex justify-between items-center bg-white">
                        <span id="projectDropdownLabel">Project</span>    <!-- âœ… ë¼ë²¨ span ì¶”ê°€ -->
                        <span>â–¼</span>
                    </button>
                    
                    <!-- ë“œë¡­ë‹¤ìš´ ë‚´ìš© -->
                    <div id="projectDropdownMenu"
                        class="absolute left-0 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden z-20">
                    
                        <!--label class="flex items-center space-x-2 font-semibold">
                            <input type="checkbox" id="project-all" class="project-master">
                            <span>ëª¨ë‘ ì„ íƒ</span>
                        </label-->
                    
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P001" data-label="êµ¬ë§¤ëŒ€í–‰">
                            <span>MRO êµ¬ë§¤ëŒ€í–‰ General Purchasing</span>
                        </label>
                    
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P018" data-label="ê²½ë¹„">
                            <span>ê²½ë¹„ Security</span>
                        </label>
                    
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P020" data-label="ë³´ì „">
                            <span>ë³´ì „ Maintenance Management</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P011" data-label="ìƒê´€ ë¬¼ë¥˜">
                            <span>ìƒê´€ ë¬¼ë¥˜ Transportation Shipping</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P008" data-label="ìƒì‚°ì§€ì›">
                            <span>ìƒì‚°ì§€ì› Production Service</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P009" data-label="ì¸ë ¥ê³µê¸‰">
                            <span>ì¸ë ¥ê³µê¸‰ Staffing</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P016" data-label="ìì‚°ê´€ë¦¬">
                            <span>ìì‚°ê´€ë¦¬ Property Management</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P013" data-label="ìì¬ ë¬¼ë¥˜">
                            <span>ìì¬ ë¬¼ë¥˜ Transportation Material</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P010" data-label="ì¥ë¹„ì„ëŒ€">
                            <span>ì¥ë¹„ì„ëŒ€ Equipment Lease</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P002" data-label="ì²­ì†Œ">
                            <span>ì²­ì†Œ Janitorial</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P017" data-label="ì¼€ì´í„°ë§">
                            <span>ì¼€ì´í„°ë§ Catering</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P019" data-label="íê¸°ë¬¼ ì²˜ë¦¬ ëŒ€í–‰">
                            <span>íê¸°ë¬¼ ì²˜ë¦¬ ëŒ€í–‰ Waste Management</span>
                        </label>

                    </div>
                </div>


                <!-- ì—…ì²´ëª… -->
                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">ì—…ì²´ëª…</h2>
                    <input type="text" id="SupplierName"
                        placeholder="ì—¬ëŸ¬ê°’ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„"
                        class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                
                <!-- Invoice No -->
                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Invoice No</h2>
                    <input type="text" id="InvoiceNo"
                        placeholder="ì—¬ëŸ¬ê°’ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„"
                        class="w-full p-2 border border-gray-300 rounded-lg">
                </div>

                <!-- â­ New Feature Button: Data Critique (Gemini API) -->
                <!-- ë˜í¼ ì¶”ê°€ ë° ê¸°ë³¸ ìˆ¨ê¹€ ì²˜ë¦¬ -->
                <div id="critique-btn-wrapper">
                    <button id="critique-btn" onclick="requestCritique()"
                            class="w-full p-3 bg-green-500 text-white rounded-lg font-bold shadow-md hover:bg-green-600 transition duration-150 disabled:bg-gray-400">
                        âœ¨ ë°ì´í„° í•„í„° Critique (Gemini)
                    </button>
                </div>
            </section>

        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <main class="flex-1 flex flex-col">

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="h-14 px-6 flex items-center border-b bg-white">
            <div>
                <h2 class="text-base font-semibold">NOVA INTEGRATED SOLUTIONS LLC</h2>
                <p class="text-sm text-gray-500">
                    êµ¬ë§¤ì´ë ¥ì„ AI í†µí•´ ì¡°íšŒ ë° ë¶„ì„í•˜ê³  AI ê²€ìƒ‰ì„ ìœ„í•œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
                </p>
            </div>
        </header>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <section id="messages" class="flex-1 flex flex-col p-4 space-y-3 bg-white">
            <div class="ai-message">
                ğŸª„ ì•ˆë…•í•˜ì„¸ìš”! AI ë¶„ì„ ëª¨ë“œë¥¼ ì„ íƒí•˜ê±°ë‚˜, ERP ë°ì´í„° ê²€ìƒ‰ì„ ìœ„í•œ í•„í„°ë¥¼ ì„ íƒí•˜ê³  ì•„ë˜ì— ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.
            </div>
        </section>

        <!-- ì•„ë˜ ì…ë ¥ ì˜ì—­ -->
        <section class="bg-white p-4">
            <div class="max-w-3xl mx-auto space-y-2">

                <!-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ (ERPì¼ ë•Œë§Œ ë³´ì„) -->
                <section id="preset-prompt-wrapper">
                    <select id="preset-prompt"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
                        <option value="">-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ (ì„ íƒ ì•ˆí•¨) --</option>
                        <option value="ì£¼ì–´ì§„ ê°’ìœ¼ë¡œ ì¡°íšŒëœ ë°ì´í„° ê²°ê³¼ë¥¼ ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ í‘œë¡œ ì •ë¦¬">ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ë¥¼ í‘œë¡œ ì •ë¦¬</option>
                        <option value="í•´ë‹¹ ê¸°ê°„ ë° Locationì—ì„œ Taxì™€ Shpping feeë¥¼ ì œì™¸í•˜ê³  ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆ ìˆœìœ„ 10ê°œë¥¼ ìˆœìœ„, itemì´ë¦„, ì´ê¸ˆì•¡, êµ¬ë§¤íšŸìˆ˜ë¡œ ë³´ì—¬ì¤˜">
                            í•´ë‹¹ ê¸°ê°„ ë° Lacationì—ì„œ ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆ ìˆœìœ„ 10ê°œ
                        </option>
                        <option value="ë‹¨ê°€ ë¹„êµë¥¼ ì—…ì²´ëª…, ì•„ì´í…œëª…, ë‹¨ê°€ë¥¼ ë‹¨ê°€ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ í‘œë¡œ ì‘ì„±">ë‹¨ê°€ ë¹„êµë¥¼ ì—…ì²´ëª…, ì•„ì´í…œëª…, ë‹¨ê°€ í‘œë¡œ ì‘ì„±</option>
                    </select>
                </section>

                <!-- GPT ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ ë°” -->
                <div class="gpt-input-bar">
                    <!-- ì™¼ìª½: AI ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
                    <button id="ai-search-toggle" class="gpt-left-btn">
                        AIëª¨ë“œ
                    </button>
                      <!-- ğŸ“ ì²¨ë¶€ ë²„íŠ¼ (ì—¬ê¸°ì—!) -->
                    <button id="attach-btn"
                            type="button"
                            class="w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 transition duration-150"
                            title="íŒŒì¼ ì²¨ë¶€">
                        ğŸ“
                    </button>
                    
                    <!-- ê°€ìš´ë°: í”„ë¡¬í”„íŠ¸ textarea -->
                    <textarea id="user-input"
                              placeholder="Location, Item, Invoice No.ë“±ì€ ì™¼ìª½ í•„í„°ì—ì„œ ì„ íƒí•˜ê³ , ì—¬ê¸°ì—ëŠ” AIì—ê²Œ ì›í•˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•©ë‹ˆë‹¤. ì²¨ë¶€ëŠ” ì´ë¯¸ì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
                              class="gpt-input"
                              rows="1"
                              oninput="autoResize(this)"></textarea>

                    <!-- ì˜¤ë¥¸ìª½: ì „ì†¡ ë²„íŠ¼ -->
                    <button onclick="sendMessage()" id="send-button"
                            class="gpt-send-btn">
                        â¤
                    </button>
                </div>
                
                <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ input (gpt-input-bar ë°–ìœ¼ë¡œ ì´ë™) -->
                <input id="file-input"
                        type="file"
                        accept="image/*"
                        multiple
                        class="hidden" />
                        
                <!-- ğŸ”½ ì²¨ë¶€ ë¯¸ë¦¬ë³´ê¸°ëŠ” bar ì•„ë˜ -->
                <div id="attachment-preview" class="msg-attachments"></div>

            </div>
        </section>

    </main>
</div>


<script>
// --- ì „ì—­ ìƒìˆ˜ ---
const MAX_FILES = 3;                       // âœ… ìµœëŒ€ íŒŒì¼ ê°œìˆ˜
const MAX_TOTAL_BYTES = 10 * 1024 * 1024; // âœ… ì´ 10MB
// ------------------------------------

window.currentEngine = null;    // 'gpt' ë˜ëŠ” 'gemini'
window.lastEngine = null;
    
// ìš°ì„  ë³€ìˆ˜ ì„ ì–¸ (try ë°–)
let responseId = null;
let conversationId = null;
    
// ğŸ”¹ "ì •ë§ ìƒˆë¡œìš´ ëŒ€í™”"ë¥¼ ì‹œì‘í•  ë•Œë§Œ í˜¸ì¶œí•  í•¨ìˆ˜
function resetConversationState() {
    window.conversationId = null;
    window.responseId = null;
}
const engineRadios = document.querySelectorAll('input[name="ai-engine"]');

engineRadios.forEach(r => {
    r.addEventListener('change', () => {
        // ì—”ì§„ì´ ë°”ë€Œë©´ ëŒ€í™” ë§¥ë½ ì™„ì „ ìƒˆë¡œ ì‹œì‘
        resetConversationState();   // ğŸ”¹ ì—¬ê¸°ì„œë§Œ ID ì´ˆê¸°í™”
        resetPromptArea();          // í”„ë¡¬í”„íŠ¸ ë‚´ìš©ë„ ì´ˆê¸°í™” (ì›í•˜ë©´ ìœ ì§€í•´ë„ ë˜ê³ )
        
        // â­ ì—”ì§„ ë³€ê²½ ì‹œ ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
        updateCritiqueButtonVisibility();

        // í•„ìš”í•˜ë©´ í™”ë©´ì— "ìƒˆ ëŒ€í™” ì‹œì‘" ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ë„ ë¨
    });
});

/**
 * í˜„ì¬ AI ì—”ì§„ ì„ íƒ ìƒíƒœì— ë”°ë¼ Critique ë²„íŠ¼ì˜ ê°€ì‹œì„±ì„ í† ê¸€í•©ë‹ˆë‹¤.
 */
function updateCritiqueButtonVisibility() {
    const selectedEngine = document.querySelector('input[name="ai-engine"]:checked')?.value;
    const critiqueWrapper = document.getElementById('critique-btn-wrapper');
    
    if (critiqueWrapper) {
        if (selectedEngine === 'gemini') {
            critiqueWrapper.classList.remove('hidden');
        } else {
            critiqueWrapper.classList.add('hidden');
        }
    }
}
    
/* textarea ìë™ ë†’ì´ ì¦ê°€ */
function autoResize(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
}
    
/* ë°ì´í„° ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸° */
const SHEET_LAST_UPDATE_URL = "https://hook.us2.make.com/3xywupvm8a60lrh5l1l6kwpqe4sjake1";
async function setEndDateFromSheet() {
    const endInput = document.getElementById("end-date");
    const startInput = document.getElementById("start-date");
    const display = document.getElementById("sheet-update-display");

    try {
        const res = await fetch(SHEET_LAST_UPDATE_URL);
        const data = await res.json();

        // 1) ì‹œíŠ¸ì—ì„œ ë°›ì€ ì—…ë°ì´íŠ¸ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹ì´ë¼ê³  ê°€ì •)
        const endStr = data.lastUpdatedDate;    // â† Make ì‘ë‹µ í‚¤ ì´ë¦„ì— ë§ê²Œ ì‚¬ìš©
        if (!endStr || !endInput || !startInput) return;

        // ì¢…ë£Œì¼ = ì—…ë°ì´íŠ¸ì¼
        endInput.value = endStr;

        // 2) ì‹œì‘ì¼ = ì¢…ë£Œì¼ ê¸°ì¤€ 1ê°œì›” ì „
        const endDateObj = parseHtmlDate(endStr); // "YYYY-MM-DD" â†’ Date
        const start = new Date(endDateObj);
        start.setMonth(start.getMonth() - 1);      // í•œ ë‹¬ ì „
        startInput.value = formatHtmlDate(start);

        // 3) í™”ë©´ì— ì„¤ëª… í…ìŠ¤íŠ¸ í‘œì‹œ (ì˜ˆ: 11/21/2025 (ê¸ˆìš”ì¼) 2:36:46 ì˜¤í›„)
        if (display) {
            const text = data.lastUpdatedText || endStr; // ì˜ˆì˜ê²Œ í¬ë§·ëœ ë¬¸ìì—´ì´ ìˆìœ¼ë©´ ì‚¬ìš©
            display.textContent = `ğŸ“Œ ERP ìµœì‹  ì—…ë°ì´íŠ¸ ë‚ ì§œ: ${text}`;
        }

    } catch (e) {
        console.error("ì—…ë°ì´íŠ¸ ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨, ì˜¤ëŠ˜ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •:", e);

        // ì‹¤íŒ¨ ì‹œ fallback: ì˜¤ëŠ˜ì„ ì¢…ë£Œì¼, í•œ ë‹¬ ì „ì„ ì‹œì‘ì¼
        const today = new Date();
        if (endInput) endInput.value = formatHtmlDate(today);

        const start = new Date(today);
        start.setMonth(start.getMonth() - 1);
        if (startInput) startInput.value = formatHtmlDate(start);

        if (display) {
            display.textContent = "ğŸ“Œ ERP ìµœì‹  ì—…ë°ì´íŠ¸ ë‚ ì§œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´, ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.";
        }
    }
}


/**
 * í˜„ì¬ ì„ íƒëœ í•„í„° ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ê°ì²´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
function collectFilterData() {
    // Dates
    const startDateValue = document.getElementById("start-date").value;
    const endDateValue = document.getElementById("end-date").value;
    const startDateObj = startDateValue ? parseHtmlDate(startDateValue) : new Date();
    const endDateObj = endDateValue ? parseHtmlDate(endDateValue) : new Date();

    const startDateDisplay = formatDisplayDate(startDateObj);
    const endDateDisplay = formatDisplayDate(endDateObj);

    // Location
    const locBoxes = document.querySelectorAll(".location-checkbox:checked");
    const locationLabels = Array.from(locBoxes).map(cb => cb.dataset.label).filter(Boolean);
    
    // Item (ì²´í¬ë°•ìŠ¤)
    const itemBoxes = document.querySelectorAll(".item-checkbox:checked");
    const itemIds = Array.from(itemBoxes).map(cb => cb.value);
    
    // Project
    const projectBoxes = document.querySelectorAll(".project-checkbox:checked");
    const projectLabels = Array.from(projectBoxes).map(cb => cb.dataset.label.trim()).filter(Boolean);

    // Text inputs
    const itemColor = document.getElementById("item-color-input").value.trim();
    const SupplierName = document.getElementById("SupplierName").value.trim();
    const InvoiceNo = document.getElementById("InvoiceNo").value.trim();

    return {
        startDate: startDateDisplay,
        endDate: endDateDisplay,
        location: locationLabels.join(", ") || 'ALL Locations',
        itemNames: itemIds.join(", ") || 'ALL Items (Checked)',
        itemCustom: itemColor || 'None',
        projects: projectLabels.join(", ") || 'ALL Projects',
        supplier: SupplierName || 'ALL Suppliers',
        invoice: InvoiceNo || 'None'
    };
}


/**
 * Gemini API í˜¸ì¶œì„ ìœ„í•œ íŠ¹ë³„ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ê³  sendMessageë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * ì´ í•¨ìˆ˜ëŠ” Geminiì˜ ë¶„ì„ ëŠ¥ë ¥(Criticism/Insight)ì„ íŠ¹ì • ì¡°ê±´ ì—†ì´ í™œìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤.
 */
function requestCritique() {
    const filters = collectFilterData();
    
    // í•„í„° ê°’ì„ í¬í•¨í•˜ëŠ” êµ¬ì²´ì ì¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
    const critiquePrompt = `Critique the currently selected ERP filter set for meaningful analysis and suggest deep-dive questions.

    --- Current Filters ---
    1. Period: ${filters.startDate} to ${filters.endDate}
    2. Location(s): ${filters.location}
    3. Item Names (Checkboxes): ${filters.itemNames}
    4. Item Custom Filter (Text): ${filters.itemCustom}
    5. Projects: ${filters.projects}
    6. Supplier Name: ${filters.supplier}
    7. Invoice No: ${filters.invoice}
    
    Based on these specific filters, suggest a focused analysis or point out any potential data integrity issues (e.g., if the time range is too long, or conflicting filters are applied).
    `;
    
    // Set the critique prompt into the user input field (for user visibility)
    const inputElement = document.getElementById('user-input');
    if (inputElement) {
        inputElement.value = critiquePrompt;
        autoResize(inputElement);
    }
    
    // Trigger the main send message function
    sendMessage();
}


/* ë‚ ì§œ í¬ë§· í•¨ìˆ˜ */
function formatHtmlDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function formatDisplayDate(date) {
    return `${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).
        padStart(2,'0')}/${date.getFullYear()}`;
}
function formatWebhookDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function parseHtmlDate(str) {
    // YYYY-MM-DD í˜•ì‹ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
    if (!str) return new Date(); // ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
    const [y,m,d] = str.split("-").map(Number);
    // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ -1
    return new Date(y, m - 1, d);
}

/* "ëª¨ë‘ ì„ íƒ" ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥ */
function setupMasterCheckbox(masterSelector, itemSelector) {
    const master = document.querySelector(masterSelector);
    const items = document.querySelectorAll(itemSelector);

    if (!master || items.length === 0) return;

    master.addEventListener("change", () => {
        items.forEach(cb => cb.checked = master.checked);
    });

    items.forEach(cb => {
        cb.addEventListener("change", () => {
            const allChecked = Array.from(items).every(x => x.checked);
            master.checked = allChecked;
        });
    });
}

/* í˜„ì¬ ì„ íƒëœ AI ëª¨ë“œ ê°’ ê°€ì ¸ì˜¤ê¸° */
function getCurrentAiMode() {
    const selected = document.querySelector('input[name="ai-mode"]:checked');
    return selected ? selected.value : null;
}

/* ERP ì„ íƒ ì‹œ: ê¸°ê°„ + Location + Item + ë¯¸ë¦¬ì •ì˜ ì§ˆë¬¸ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° */
function updateErpVisibility() {
    const mode = getCurrentAiMode();
    const isErp = (mode === 'erp');

    const periodSection = document.getElementById('period-section');
    const erpOptionsSection = document.getElementById('erp-options-section');
    const presetWrapper = document.getElementById('preset-prompt-wrapper');

    [periodSection, erpOptionsSection, presetWrapper].forEach(el => {
        if (!el) return;
        if (isErp) el.classList.remove('hidden');
        else el.classList.add('hidden');
    });
}

function updateAiModeStyling() {
    const aiMode = getCurrentAiMode();
    const textarea = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");

    if (aiMode === "ai") {
        textarea.classList.add("ai-mode-active-textarea");
        sendButton.classList.add("ai-mode-active-button");
    } else {
        textarea.classList.remove("ai-mode-active-textarea");
        sendButton.classList.remove("ai-mode-active-button");
    }
}

/* ERP/AI ì„ íƒ ì‹œ: í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” */
function resetPromptArea() {
    const textarea = document.getElementById("user-input");
    if (textarea) {
        textarea.value = "";
        autoResize(textarea);
    }
}
    /* ERP/AI ì„ íƒ ì‹œ: í”„ë¡¬í”„íŠ¸ placeholder ë³€ */
function updatePromptPlaceholder() {
    const textarea = document.getElementById("user-input");
    const aiMode = getCurrentAiMode();

    if (!textarea) return;

    if (aiMode === "erp") {
        textarea.placeholder =
            "Location, Item, Invoice No.ë“±ì€ ì™¼ìª½ í•„í„°ì—ì„œ ì„ íƒí•˜ê³ , ì—¬ê¸°ì—ëŠ” AIì—ê²Œ ì›í•˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•©ë‹ˆë‹¤.";
    } else {
        textarea.placeholder =
            "ë¬´ì—‡ì´ë“  ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.";
    }
}
    //í”„ë¡œì íŠ¸ì„ íƒì„ ìœ„
const projectBtn = document.getElementById("projectDropdownBtn");
const projectMenu = document.getElementById("projectDropdownMenu");

// ë²„íŠ¼ í´ë¦­ â†’ í† ê¸€ ì—´ê¸°/ë‹«ê¸°
projectBtn.addEventListener("click", () => {
    projectMenu.classList.toggle("hidden");
});

// ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener("click", (e) => {
    if (!projectBtn.contains(e.target) && !projectMenu.contains(e.target)) {
        projectMenu.classList.add("hidden");
    }
});


/* í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” */
document.addEventListener("DOMContentLoaded", () => {

    setupMasterCheckbox("#location-all", ".location-checkbox");
    setupMasterCheckbox("#item-all", ".item-checkbox");
    setupMasterCheckbox("#project-all", ".project-checkbox");

    // ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ ì‹œ textareaì— ìë™ ì…ë ¥
    const presetSelect = document.getElementById("preset-prompt");
    const userInput = document.getElementById("user-input");

    if (presetSelect && userInput) {
        presetSelect.addEventListener("change", () => {
            const value = presetSelect.value || "";
            userInput.value = value;
            autoResize(userInput);
        });
    }

    // GPT ìŠ¤íƒ€ì¼: Enter â†’ ì „ì†¡, Shift+Enter â†’ ì¤„ë°”ê¿ˆ
    if (userInput) {
        userInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                if (!e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            }
        });
    }

    // í”„ë¡¬í”„íŠ¸ ì˜† AI ê²€ìƒ‰ í† ê¸€ ë²„íŠ¼ & ë¼ë””ì˜¤ ë™ê¸°í™”
    const aiToggleBtn = document.getElementById('ai-search-toggle');
    const aiRadios = document.querySelectorAll('input[name="ai-mode"]');

    if (aiToggleBtn) {
        // í† ê¸€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¼ë””ì˜¤ë„ ê°™ì´ ë°”ë€œ
        aiToggleBtn.addEventListener('click', () => {
            const isActive = aiToggleBtn.classList.toggle('ai-toggle-active'); // on/off

            const targetValue = isActive ? 'ai' : 'erp';
            const targetRadio = document.querySelector(
                `input[name="ai-mode"][value="${targetValue}"]`
            );
            if (targetRadio) {
                targetRadio.checked = true;
            }

            updateErpVisibility();
            updateAiModeStyling();
            updatePromptPlaceholder();
            updateCritiqueButtonVisibility(); // â­ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
            resetPromptArea();
        });

        // ë¼ë””ì˜¤ë¥¼ ë°”ê¾¸ë©´ í† ê¸€ ìƒíƒœë„ ë”°ë¼ê°
        aiRadios.forEach(r => {
            r.addEventListener('change', () => {
                const isAi = r.value === 'ai' && r.checked;
                if (isAi) {
                    aiToggleBtn.classList.add('ai-toggle-active');
                } else {
                    aiToggleBtn.classList.remove('ai-toggle-active');
                }
    

                updateErpVisibility();
                updateAiModeStyling();
                updatePromptPlaceholder();
                updateCritiqueButtonVisibility(); // â­ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
                resetPromptArea();
            });
        });
    }
    
    // AI ì—”ì§„ ë¼ë””ì˜¤ (Gemini/GPT) ë³€ê²½ ì‹œ
    document.querySelectorAll('input[name="ai-engine"]').forEach(r => {
        r.addEventListener('change', updateCritiqueButtonVisibility);
    });

    // ğŸ”¹ Project ë“œë¡­ë‹¤ìš´ ë¼ë²¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateProjectLabel() {
        const labelSpan = document.getElementById("projectDropdownLabel");
        if (!labelSpan) return;
    
        const checked = document.querySelectorAll(".project-checkbox:checked");
        const labels = Array.from(checked).map(cb => cb.dataset.label || cb.value);
    
        if (labels.length === 0) {
            labelSpan.textContent = "Project"; // ê¸°ë³¸ í…ìŠ¤íŠ¸
        } else if (labels.length > 2) {
            // ë§ˆì§€ë§‰ìœ¼ë¡œ í´ë¦­í•œ ì²´í¬ë°•ìŠ¤ë¥¼ í•´ì œ
            event.target.checked = false;

            // ì•ˆë‚´ ë©”ì‹œì§€ (í•„ìš” ì‹œ ì‚­ì œ ê°€ëŠ¥)
            alert("í”„ë¡œì íŠ¸ëŠ” ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return; // ì•„ë˜ UI ì—…ë°ì´íŠ¸ëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
        } else if (labels.length <= 2) {          
            // ì´ë¦„ í‘œì‹œ
            labelSpan.textContent = labels.join(", ");
        } 
    }
    
    // âœ… Project ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œë§ˆë‹¤ ë¼ë²¨ ê°±ì‹ 
    document.querySelectorAll(".project-checkbox, #project-all").forEach(el => {
        el.addEventListener("change", updateProjectLabel);
    });
    
    // í˜ì´ì§€ ì²˜ìŒ ë¡œë“œí•  ë•Œë„ í•œ ë²ˆ ë§ì¶°ì£¼ê¸°
    updateProjectLabel();


    // ì´ˆê¸° í‘œì‹œ ìƒíƒœ
    setEndDateFromSheet();
    updateErpVisibility();
    updateAiModeStyling();
    updateCritiqueButtonVisibility(); // â­ ì´ˆê¸° ë¡œë“œ ì‹œ ê°€ì‹œì„± ì„¤ì •
    autoResize(userInput);
});

// âœ… ì²¨ë¶€ íŒŒì¼(ëª¨ë“  íŒŒì¼) ëª©ë¡: ì—¬ëŸ¬ ê°œ ì§€ì›
window.attachedImages = []; // File[]

// ----------------------------------------------------
// --- íŒŒì¼ ì²¨ë¶€ ë° ë¯¸ë¦¬ë³´ê¸° (ëª¨ë“  íŒŒì¼ íƒ€ì… ì§€ì›) ---
// ----------------------------------------------------

// âœ… ë¯¸ë¦¬ë³´ê¸° ë Œë” (ìˆ˜ì •ë¨)
function renderAttachments() {
    const wrap = document.getElementById("attachment-preview");
    if (!wrap) return;

    wrap.innerHTML = "";
    if (window.attachedImages.length === 0) return;

    window.attachedImages.forEach((file, idx) => {
        const url = URL.createObjectURL(file);

        const item = document.createElement("div");
        item.className = "thumb-wrap";
        
        let fileContentHtml = '';
        let fileNameDisplay = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;

        // íŒŒì¼ ìœ í˜•ì— ë”°ë¼ ë¯¸ë¦¬ë³´ê¸° ë° ì•„ì´ì½˜ ê²°ì •
        if (file.type.startsWith("image/")) {
            // ì´ë¯¸ì§€ íŒŒì¼: ì¸ë„¤ì¼ë¡œ ë Œë”ë§
            fileContentHtml = `<img src="${url}" class="thumb" alt="${file.name}" />`;
        } else {
            // ì´ë¯¸ì§€ ì™¸ íŒŒì¼: ì•„ì´ì½˜ê³¼ íŒŒì¼ëª… í‘œì‹œ
            let iconSvg;
            if (file.type.includes('pdf')) {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 w-6 h-6"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="16" y2="16"/></svg>`; // PDF Icon
            } else if (file.type.includes('text')) {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 w-6 h-6"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L15 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`; // Text Icon
            } else {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 w-6 h-6"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/></svg>`; // Generic File Icon
            }
            
            fileContentHtml = `
                <div class="flex flex-col items-center justify-center h-full">
                    ${iconSvg}
                    <span class="text-xs mt-1 text-gray-700 font-medium">${fileNameDisplay}</span>
                    <span class="text-xs text-gray-500">${bytesToMB(file.size)}MB</span>
                </div>
            `;
            // ì¸ë„¤ì¼ ëŒ€ì‹  íŒŒì¼ ì•„ì´ì½˜ê³¼ ì´ë¦„ì´ ë“¤ì–´ê°€ë„ë¡ thumb-wrap ë‚´ë¶€ ìŠ¤íƒ€ì¼ ì¡°ì •ì´ í•„ìš”
        }


        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "thumb-remove";
        btn.textContent = "Ã—";
        btn.onclick = () => {
            URL.revokeObjectURL(url);
            window.attachedImages.splice(idx, 1);
            renderAttachments();
        };

        item.innerHTML = fileContentHtml;
        item.appendChild(btn);
        wrap.appendChild(item);
    });
}

// âœ… FileList / Clipboard itemsì—ì„œ íŒŒì¼ Fileë§Œ ì¶”ì¶œí•˜ì—¬ ì¶”ê°€ (ì´ë¯¸ì§€ í•„í„°ë§ ì œê±°ë¨)
function bytesToMB(bytes) {
    return (bytes / (1024 * 1024)).toFixed(2);
}

function currentTotalBytes() {
    return (window.attachedImages || []).reduce((sum, f) => sum + (f?.size || 0), 0);
}

function addImageFiles(files) {
    const arr = Array.from(files || []).filter(f => f);
    
    // ì´ë¯¸ì§€ íŒŒì¼ë§Œ í—ˆìš©
    const candidates = arr.filter(f => f.type.startsWith("image/"));
    if (!candidates.length) return;

    window.attachedImages = window.attachedImages || [];

    // 1) ì¥ìˆ˜ ì œí•œ
    const remain = MAX_FILES - window.attachedImages.length;
    if (remain <= 0) {
        pushWarn(`ì²¨ë¶€ íŒŒì¼ì€ ìµœëŒ€ ${MAX_FILES}ê°œê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        return;
    }

    const finalCandidates = candidates.slice(0, remain); // candidatesì—ì„œ ë‚¨ì€ ê°œìˆ˜ë§Œí¼ ìŠ¬ë¼ì´ìŠ¤

    // 2) ìš©ëŸ‰ ì œí•œ
    let total = currentTotalBytes();
    const accepted = [];

    for (const file of finalCandidates) {
        const next = total + file.size;
        if (next > MAX_TOTAL_BYTES) {
            pushWarn(`ì´ ì²¨ë¶€ ìš©ëŸ‰ì€ ${bytesToMB(MAX_TOTAL_BYTES)}MBê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            break;
        }
        accepted.push(file);
        total = next;
    }

    if (!accepted.length) return;

    window.attachedImages = window.attachedImages.concat(accepted);

    // 3) ë¯¸ë¦¬ë³´ê¸° ë Œë”
    renderAttachments();
}


document.addEventListener("DOMContentLoaded", () => {
    const textarea = document.getElementById("user-input");
    const fileInput = document.getElementById("file-input");
    const attachBtn = document.getElementById("attach-btn");

    // â‘  íŒŒì¼ ì„ íƒ ë²„íŠ¼ â†’ file input ì—´ê¸°
    if (attachBtn && fileInput) {
        attachBtn.addEventListener("click", () => fileInput.click());
    }

    // â‘¡ íŒŒì¼ ì„ íƒ input ë³€ê²½ â†’ ì²¨ë¶€ ì¶”ê°€
    if (fileInput) {
        fileInput.addEventListener("change", () => {
            addImageFiles(fileInput.files);
            fileInput.value = ""; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
        });
    }

    // â‘¢ ë¶™ì—¬ë„£ê¸°(Ctrl/Cmd+V) â†’ ì²¨ë¶€ ì¶”ê°€
    if (textarea) {
        textarea.addEventListener("paste", (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            const files = [];
            for (const it of items) {
                // â­ ì´ë¯¸ì§€ íƒ€ì… í•„í„°ë§ ì œê±° (ëª¨ë“  í´ë¦½ë³´ë“œ í•­ëª©ì„ íŒŒì¼ë¡œ ì‹œë„)
                const f = it.getAsFile();
                if (f) files.push(f);
            }
            if (files.length) addImageFiles(files);
        });
    }

    // â‘£ ë“œë˜ê·¸&ë“œë¡­ â†’ ì²¨ë¶€ ì¶”ê°€ (textarea ìœ„ë¡œ ë“œë¡­)
    if (textarea) {
        textarea.addEventListener("dragover", (e) => {
            e.preventDefault();
            textarea.classList.add("drop-hint");
        });

        textarea.addEventListener("dragleave", () => {
            textarea.classList.remove("drop-hint");
        });

        textarea.addEventListener("drop", (e) => {
            e.preventDefault();
            textarea.classList.remove("drop-hint");

            const files = e.dataTransfer?.files;
            if (files && files.length) addImageFiles(files);
        });
    }
});


/* ì „ì†¡ ë¡œì§ */
// â­ ìˆ˜ì •: ì‚¬ìš©ìê°€ ì‹¤ì œ URLì„ ì…ë ¥í•˜ë„ë¡ ì£¼ì„ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/i1gghzgvi0ptcyfpssyp5wim979end1e";
    //"https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq"; //data dtore
// ğŸ‘† WARNING: ì´ URLì€ ì„ì‹œ ì˜ˆì‹œ ì£¼ì†Œì…ë‹ˆë‹¤. Makeì—ì„œ ë°œê¸‰ë°›ì€ ì‹¤ì œ Webhook ì£¼ì†Œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
let isSending = false;

// ì´ë¯¸ì§€ íŒŒì¼ì„ Base64 ë°ì´í„° URLë¡œ ì½ì–´ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜
async function readFileAsDataURL(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
    });
}

function escapeHtml(str = "") {
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
}

function createUserMessageElement({ text, filtersText = "", attachmentsHtml = "" }) {
    const wrapper = document.createElement("div");
    wrapper.className = "user-message";
    wrapper.dataset.author = "user";

    const textBlock = document.createElement("div");
    textBlock.className = "message-text";
    textBlock.textContent = text;
    wrapper.appendChild(textBlock);

    if (filtersText) {
        const meta = document.createElement("span");
        meta.className = "message-meta";
        meta.textContent = `(í•„í„°: ${filtersText})`;
        wrapper.appendChild(meta);
    }

    if (attachmentsHtml) {
        const attachWrap = document.createElement("div");
        attachWrap.className = "msg-attachments";
        attachWrap.innerHTML = attachmentsHtml;
        wrapper.appendChild(attachWrap);
    }

    const editBtn = document.createElement("button");
    editBtn.type = "button";
    editBtn.className = "message-edit-btn";
    editBtn.title = "ë‚´ ë©”ì‹œì§€ ìˆ˜ì •";
    editBtn.textContent = "âœï¸";
    editBtn.addEventListener("click", () => {
        const current = textBlock.textContent || "";
        const nextValue = prompt("ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.", current);
        if (nextValue === null) return;
        const trimmed = nextValue.trim();
        if (!trimmed) return;
        textBlock.textContent = trimmed;
    });

    wrapper.appendChild(editBtn);
    return wrapper;
}

function createAiMessageElement(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "ai-message";
    wrapper.innerHTML = `ğŸª„ ${escapeHtml(text).replace(/\n/g, "<br>")}`;
    return wrapper;
}

async function sendMessage() {
    const textarea = document.getElementById("user-input");
    const selectElement = document.getElementById("preset-prompt");
    const sendButton = document.getElementById("send-button");
    const messagesDiv = document.getElementById("messages");

    // í”„ë¡¬í”„íŠ¸ ì°½ ë‚´ìš©ë§Œ ì „ì†¡
    const message = textarea.value.trim();

    if (!message || isSending) {
        if (!message && !isSending) {
            messagesDiv.innerHTML += `<div class="ai-message self-start bg-yellow-100 text-yellow-700">âš ï¸ ì˜¤ë¥˜: ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        return;
    }

    // â­ í•„í„° ë°ì´í„° ìˆ˜ì§‘
    const filterData = collectFilterData();

    // Location
    const locBoxes = document.querySelectorAll(".location-checkbox:checked");
    const locationIds = Array.from(locBoxes).map(cb => cb.value);
    const locationLabels = Array.from(locBoxes).map(cb => cb.dataset.label);
    const locationLabel = locationLabels.join(", ");

    // Item
    const itemBoxes = document.querySelectorAll(".item-checkbox:checked");
    const itemIds = Array.from(itemBoxes).map(cb => cb.value);
    const itemLabel = itemIds.join(", ");

    // Item ì‚¬ìš©ì ì…ë ¥
    const itemColor = document.getElementById("item-color-input").value.trim();

    // AI ëª¨ë“œ (ë¼ë””ì˜¤)
    const aiRadio = document.querySelector('input[name="ai-mode"]:checked');
    const aiMode = aiRadio ? aiRadio.value : null;
    const aiModeLabel = aiRadio ? aiRadio.dataset.label : "";

    // ì„ íƒëœ AI ì—”ì§„ (GPT / Gemini ë“±)
    const aiEngineRadio = document.querySelector('input[name="ai-engine"]:checked');
    const aiEngine = aiEngineRadio ? aiEngineRadio.value : null;        // "gpt", "gemini" ...
    const aiEngineLabel = aiEngineRadio ? aiEngineRadio.dataset.label : ""; // "GPT", "Gemini"

    // âœ… Project (ì²´í¬ëœ ê²ƒë§Œ)
    const projectBoxes = document.querySelectorAll(".project-checkbox:checked");
    const projectIds = Array.from(projectBoxes).map(cb => cb.value.trim()).filter(Boolean);
    const projectLabels = Array.from(projectBoxes).map(cb => cb.dataset.label.trim()).filter(Boolean);
    
    // Makeë¡œ ë³´ë‚¼ "ProjectCode" (ì½¤ë§ˆë¡œ í•©ì¹¨)
    const projectCode = projectIds.join(",");
    const projectLabel = projectLabels.join(",");

    // ì‹ ê·œ ì…ë ¥ í•„ë“œ
    const SupplierName = document.getElementById("SupplierName").value.trim();
    const InvoiceNo = document.getElementById("InvoiceNo").value.trim();
    
    // Webhook ì „ì†¡ì„ ìœ„í•œ YYYY-MM-DD í˜•ì‹ ë°ì´í„°
    const startDateForWebhook = document.getElementById('start-date').value;
    const endDateForWebhook = document.getElementById('end-date').value;


 // ğŸ”¥ AI ëª¨ë¸ì´ ë°”ë€Œì—ˆìœ¼ë©´ session ì´ˆê¸°í™”
    if (window.lastAiModel && window.lastAiModel !== aiMode) {
        window.conversationId = null;
        window.responseId = null;
    }

    // ì—”ì§„ ë°”ë€Œì—ˆìœ¼ë©´ session ê´€ë ¨ ID ì‹¹ ì§€ìš°ê¸°
    if (window.lastEngine && window.lastEngine !== aiEngine) {
        window.conversationId = null;
        window.responseId = null;
    }
    window.currentEngine = aiEngine;
    window.lastEngine = aiEngine;

    // í˜„ì¬ ai ëª¨ë¸ ê¸°ë¡
    window.lastAiModel = aiMode;
    
    // ERP ì„ íƒ ì‹œ: 4ê°œ ì¤‘ í•˜ë‚˜ëŠ” í•„ìˆ˜
    if (aiMode === 'erp' &&
        itemIds.length === 0 &&
        !itemColor &&
        !SupplierName &&
        !InvoiceNo
    ) {
        messagesDiv.innerHTML += `
            <div class="ai-message self-start bg-yellow-100 text-yellow-700">
                âš ï¸ ERP ë¶„ì„ì„ ì„ íƒí•œ ê²½ìš°, ì œí’ˆëª…Â·Item ì‚¬ìš©ì ì…ë ¥Â·ì—…ì²´ëª…Â·Invoice No ì¤‘ ìµœì†Œ 1ê°œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
            </div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return;
    }

    isSending = true;
    sendButton.disabled = true;

    // í™”ë©´ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
    let filterTxt = [];
    if (aiEngineLabel) filterTxt.push(`AI ì—”ì§„: ${aiEngineLabel}`);
    if (aiModeLabel) filterTxt.push(`AI ëª¨ë“œ: ${aiModeLabel}`);
    if (aiMode === 'erp') {
        if (filterData.startDate) filterTxt.push(`ì‹œì‘ì¼: ${filterData.startDate}`);
        if (filterData.endDate) filterTxt.push(`ì¢…ë£Œì¼: ${filterData.endDate}`);
        if (locationLabels.length) filterTxt.push(`Location: ${locationLabel}`);
        if (itemLabel) filterTxt.push(`Item: ${itemLabel}`);
        if (itemColor) filterTxt.push(`Item ì‚¬ìš©ì ì…ë ¥: ${itemColor}`);
        if (SupplierName) filterTxt.push(`ì—…ì²´ëª…: ${SupplierName}`);
        if (InvoiceNo) filterTxt.push(`Invoice No: ${InvoiceNo}`);
        if (projectLabel) filterTxt.push(`Project: ${projectLabel}`);
    } 

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥ìš© ì¸ë„¤ì¼ HTML ìƒì„± (Base64ë¡œ ë¹„ë™ê¸° ë³€í™˜í•˜ì—¬ ì´ë¯¸ì§€ ê¹¨ì§ ë°©ì§€)
    const attachmentParts = await Promise.all((window.attachedImages || []).map(async (file) => {
      const safeName = escapeHtml(file.name || "attachment");
      if (file.type.startsWith("image/")) {
        const base64Data = await readFileAsDataURL(file);
        return `<img src="${base64Data}" alt="${safeName}" />`;
      } else {
        // ì´ë¯¸ì§€ ì™¸ íŒŒì¼ì— ëŒ€í•œ í‘œì‹œ ë°©ì‹ (ì‘ì€ ì•„ì´ì½˜)
        let iconHtml = '<span class="text-xs text-white">FILE</span>';
        if (file.type.includes('pdf')) iconHtml = '<span class="text-xs text-white">PDF</span>';
        else if (file.type.includes('text')) iconHtml = '<span class="text-xs text-white">TXT</span>';
        
        return `<div class="w-16 h-16 rounded-lg bg-indigo-700 flex flex-col items-center justify-center p-1" title="${safeName}">
                    ${iconHtml}
                    <span class="text-xs text-white truncate w-full text-center">${escapeHtml(file.name.substring(0, 10))}</span>
                </div>`;
      }
    }));
    const attachmentsForBubble = attachmentParts.join("");

    const userMessageEl = createUserMessageElement({
        text: message,
        filtersText: filterTxt.join(", "),
        attachmentsHtml: attachmentsForBubble
    });

    messagesDiv.appendChild(userMessageEl);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    textarea.value = "";
    autoResize(textarea);
    if (!document.getElementById('preset-prompt-wrapper').classList.contains('hidden')) {
        selectElement.value = "";
    }

    const loadingDiv = document.createElement("div");
    loadingDiv.id = "loading";
    loadingDiv.innerHTML = `
            <div class="stage">
              <div class="dot-floating"></div>
            </div>
    `;
    messagesDiv.appendChild(loadingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
    // ì„¸ì…˜ ID ê´€ë¦¬
    if (conversationId) {
        window.conversationId = conversationId;
    }
    if (responseId) {
        window.responseId = responseId;
    }

    try {
        if (!MAKE_WEBHOOK_URL || MAKE_WEBHOOK_URL.length < 10) {
            throw new Error("Make Webhook URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }

        const body = {
            prompt: message,
            startDate: startDateForWebhook, // YYYY-MM-DD
            endDate: endDateForWebhook,     // YYYY-MM-DD
            location: locationIds.join(","),
            locationLabel,
            item: itemLabel,
            itemColor,
            aiMode,
            aiModeLabel,
            SupplierName,
            InvoiceNo,
            ProjectCode: projectCode,
            aiEngine,
            aiEngineLabel,
            conversationId: window.conversationId || null,
            responseId: window.responseId || null
        };

        const formData = new FormData();

        Object.entries(body).forEach(([k, v]) => {
          if (typeof v === "object") formData.append(k, JSON.stringify(v));
          else formData.append(k, v ?? "");
        });
        
        (window.attachedImages || []).forEach((file, idx) => {
          formData.append("files", file, file.name || `attached-file-${idx}`);
        });
        
        const response = await fetch(MAKE_WEBHOOK_URL, {
          method: "POST",
          body: formData,
        });

        const rawText = await response.text();

        responseId = response.headers.get("ResponseID");
        conversationId = response.headers.get("ConversationID");

        if (aiEngine === 'gpt' && window.responseId && window.responseId.startsWith('resp_')) {
            body.responseId = window.responseId;
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status} ${response.statusText} / body: ${rawText}`);
        }

        loadingDiv.remove();

        messagesDiv.appendChild(createAiMessageElement(rawText));

    } catch (err) {
        loadingDiv.remove();
        console.error("ì›¹í›… í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        const msg = (err && err.message ? err.message : String(err))
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        messagesDiv.innerHTML += `
            <div class="ai-message bg-red-100 text-red-700 text-sm">
                âš ï¸ ì„œë²„(Make) ì‹¤í–‰ ì˜¤ë¥˜: ${msg}. Make ì‹œë‚˜ë¦¬ì˜¤ì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </div>
        `;
    } finally {
        if (conversationId && conversationId !== "null" && conversationId !== "") {
            window.conversationId = conversationId;
        }
        if (responseId && responseId !== "null" && responseId !== "") {
            window.responseId = responseId;
        }

        sendButton.disabled = false;
        window.attachedImages = [];
        renderAttachments();
        isSending = false;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
}
</script>

</body>
</html>
