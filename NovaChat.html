<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP-Gemini ì±—ë´‡</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        #messages {
            overflow-y: auto;
        }
        .user-message {
            @apply bg-indigo-500 text-white p-3 rounded-lg shadow-md mb-2 max-w-3xl self-end ml-auto;
        }
        .ai-message {
            @apply bg-gray-100 text-gray-800 p-3 rounded-lg shadow-md mb-2 max-w-3xl self-start mr-auto;
        }
        #loading {
            @apply text-sm text-gray-500 italic mb-2;
        }

        /* textarea ìë™ ë†’ì´ ì¦ê°€ */
        textarea {
            overflow-y: auto;
            resize: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen">

<div class="flex h-screen">

    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <aside class="w-80 bg-white border-r flex flex-col">
        <div class="p-4 border-b">
            <h1 class="text-lg font-bold text-indigo-600">ERP-Gemini í•„í„°</h1>
            <p class="text-xs text-gray-500 mt-1">
                ê¸°ê°„, Location, Item, AI ëª¨ë“œë¥¼ ì„ íƒí•œ ë’¤ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.
            </p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">

            <!-- ê¸°ê°„ ì„ íƒ -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">ê¸°ê°„ ì„ íƒ</h2>
                <div class="space-y-2">
                    <label class="text-xs">ì‹œì‘ì¼</label>
                    <input type="date" id="start-date"
                           class="w-full p-2 border border-gray-300 rounded-lg">

                    <label class="text-xs">ì¢…ë£Œì¼</label>
                    <input type="date" id="end-date"
                           class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </section>

            <!-- Location -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">Location</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-1">

                    <label class="flex items-center space-x-2 font-semibold">
                        <input type="checkbox" id="location-all" class="location-master">
                        <span>ëª¨ë‘ ì„ íƒ</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1007" data-label="SEA">
                        <span>SEA</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1008" data-label="SEG">
                        <span>SEG</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1006" data-label="SEMA">
                        <span>SEMA</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1005" data-label="SEMS">
                        <span>SEMS</span>
                    </label>
                </div>
            </section>

            <!-- Item -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">Item (ì œí’ˆëª…)</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                    
                    <label class="flex items-center space-x-2 font-semibold">
                        <input type="checkbox" id="item-all" class="item-master">
                        <span>ëª¨ë‘ ì„ íƒ</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="item-checkbox" value="Label, label, LABEL">
                        <span>Label</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="item-checkbox" value="Ribbon">
                        <span>Ribbon</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="item-checkbox" value="Film">
                        <span>Film</span>
                    </label>
                </div>
            </section>

            <!-- Item íŠ¹ì„± -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">Item íŠ¹ì„±</h2>
                <input type="text" id="item-color-input"
                       placeholder="ì˜ˆ: Black, White, Strong..."
                       class="w-full p-2 border border-gray-300 rounded-lg">
            </section>

            <!-- AI ë¶„ì„ ëª¨ë“œ -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ë¶„ì„ ëª¨ë“œ</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">

                    <label class="flex items-center space-x-2 font-semibold">
                        <input type="checkbox" id="ai-all" class="ai-master">
                        <span>ëª¨ë‘ ì„ íƒ</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <!-- â­ ê¸°ë³¸ ì²´í¬ë¨ -->
                        <input type="checkbox" class="ai-mode-checkbox" value="erp" data-label="ERP ë¶„ì„" checked>
                        <span>ERP ë¶„ì„</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="ai-mode-checkbox" value="ai" data-label="AI ì„œì¹˜">
                        <span>AI ì„œì¹˜</span>
                    </label>

                </div>
            </section>

        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <main class="flex-1 flex flex-col">

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="h-14 px-6 flex items-center border-b bg-white">
            <div>
                <h2 class="text-base font-semibold">ERP-Gemini ì±—ë´‡</h2>
                <p class="text-xs text-gray-500">
                    ì™¼ìª½ì—ì„œ ì¡°ê±´ì„ ì„ íƒí•˜ê³  ì•„ë˜ì—ì„œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.
                </p>
            </div>
        </header>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <section id="messages" class="flex-1 flex flex-col p-4 space-y-3 bg-gray-50">
            <div class="ai-message">
                ğŸ¤– ì•ˆë…•í•˜ì„¸ìš”! ì™¼ìª½ì—ì„œ ì¡°ê±´ì„ ì„ íƒí•œ ë’¤ ì•„ë˜ì— ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.
            </div>
        </section>

        <!-- ì•„ë˜ ì…ë ¥ ì˜ì—­ -->
        <section class="border-t bg-white p-4">
            <div class="max-w-3xl mx-auto space-y-3">

                <!-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ -->
                <select id="preset-prompt"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
                    <option value="">-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ (ì„ íƒ ì•ˆí•¨) --</option>
                    <option value="í•´ë‹¹ ê¸°ê°„ ë° ì§€ì—­ì—ì„œ ê°€ì¥ ë§ì´ íŒ”ë¦° ì œí’ˆì€?">
                        í•´ë‹¹ ê¸°ê°„ ë° ì§€ì—­ì—ì„œ ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆì€?
                    </option>
                    <option value="ë‹¨ê°€ ë¹„êµ í‘œ ì‘ì„±">ë‹¨ê°€ ë¹„êµ í‘œ ì‘ì„±</option>
                </select>

                <!-- í”„ë¡¬í”„íŠ¸ textarea -->
                <div class="flex space-x-3 items-end">
                    <textarea id="user-input"
                              placeholder="ì—¬ê¸°ì— ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                              class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm leading-relaxed"
                              rows="1"
                              style="max-height: 200px;"
                              oninput="autoResize(this)"
                              onkeypress="if(event.keyCode === 13 && !event.shiftKey){ event.preventDefault(); sendMessage(); }"></textarea>

                    <button onclick="sendMessage()" id="send-button"
                            class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 shadow-md disabled:bg-gray-400 text-sm">
                        ì „ì†¡
                    </button>
                </div>

            </div>
        </section>

    </main>
</div>


<script>
/* --------------------------
    textarea ìë™ ë†’ì´ ì¦ê°€
---------------------------*/
function autoResize(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
}

/* --------------------------
   ë‚ ì§œ í¬ë§· í•¨ìˆ˜
---------------------------*/
function formatHtmlDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function formatDisplayDate(date) {
    return `${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}/${date.getFullYear()}`;
}
function formatWebhookDate(date) {
    return `${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}${date.getFullYear()}`;
}
function parseHtmlDate(str) {
    const [y,m,d] = str.split("-");
    return new Date(parseInt(y), parseInt(m)-1, parseInt(d));
}

/* --------------------------
   "ëª¨ë‘ ì„ íƒ" ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥
---------------------------*/
function setupMasterCheckbox(masterSelector, itemSelector) {
    const master = document.querySelector(masterSelector);
    const items = document.querySelectorAll(itemSelector);

    if (!master || items.length === 0) return;

    // ë§ˆìŠ¤í„° í´ë¦­ â†’ ì „ì²´ í† ê¸€
    master.addEventListener("change", () => {
        items.forEach(cb => cb.checked = master.checked);
    });

    // ê°œë³„ ë³€ê²½ â†’ ë§ˆìŠ¤í„° ìƒíƒœ ì—…ë°ì´íŠ¸
    items.forEach(cb => {
        cb.addEventListener("change", () => {
            const allChecked = Array.from(items).every(x => x.checked);
            master.checked = allChecked;
        });
    });
}

/* --------------------------
   í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
---------------------------*/
document.addEventListener("DOMContentLoaded", () => {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear()-1);

    document.getElementById("start-date").value = formatHtmlDate(oneYearAgo);
    document.getElementById("end-date").value = formatHtmlDate(today);

    setupMasterCheckbox("#location-all", ".location-checkbox");
    setupMasterCheckbox("#item-all", ".item-checkbox");
    setupMasterCheckbox("#ai-all", ".ai-mode-checkbox");
});


/* --------------------------
    ì „ì†¡ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
---------------------------*/
const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq";
let isSending = false;

async function sendMessage() {
    const textarea = document.getElementById("user-input");
    const selectElement = document.getElementById("preset-prompt");
    const sendButton = document.getElementById("send-button");
    const messagesDiv = document.getElementById("messages");

    const presetMessage = selectElement.value;
    const typedMessage = textarea.value.trim();
    const message = presetMessage || typedMessage;

    if (!message || isSending) return;

    const startDateObj = parseHtmlDate(document.getElementById("start-date").value);
    const endDateObj = parseHtmlDate(document.getElementById("end-date").value);

    const startDateDisplay = formatDisplayDate(startDateObj);
    const endDateDisplay = formatDisplayDate(endDateObj);
    const startDateForWebhook = formatWebhookDate(startDateObj);
    const endDateForWebhook = formatWebhookDate(endDateObj);

    const locBoxes = document.querySelectorAll(".location-checkbox:checked");
    const locationIds = Array.from(locBoxes).map(cb => cb.value);
    const locationLabels = Array.from(locBoxes).map(cb => cb.dataset.label);

    const itemBoxes = document.querySelectorAll(".item-checkbox:checked");
    const itemIds = Array.from(itemBoxes).map(cb => cb.value);
    const itemLabel = itemIds.join(", ");

    const itemColor = document.getElementById("item-color-input").value.trim();

    const aiBoxes = document.querySelectorAll(".ai-mode-checkbox:checked");
    const aiMode = Array.from(aiBoxes).map(cb => cb.value);
    const aiModeLabels = Array.from(aiBoxes).map(cb => cb.dataset.label);

    // í™”ë©´ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
    let filterTxt = [];
    if (startDateDisplay) filterTxt.push(`ì‹œì‘ì¼: ${startDateDisplay}`);
    if (endDateDisplay) filterTxt.push(`ì¢…ë£Œì¼: ${endDateDisplay}`);
    if (locationLabels.length) filterTxt.push(`Location: ${locationLabels.join(", ")}`);
    if (itemLabel) filterTxt.push(`Item: ${itemLabel}`);
    if (itemColor) filterTxt.push(`Item íŠ¹ì„±: ${itemColor}`);
    if (aiModeLabels.length) filterTxt.push(`AI ëª¨ë“œ: ${aiModeLabels.join(", ")}`);

    messagesDiv.innerHTML += `
        <div class="user-message">
            ${message}
            ${filterTxt.length ? `<br><span class="text-xs opacity-80">(í•„í„°: ${filterTxt.join(", ")})</span>` : ""}
        </div>`;

    textarea.value = "";
    textarea.style.height = "auto";
    selectElement.value = "";

    const loadingDiv = document.createElement("div");
    loadingDiv.id = "loading";
    loadingDiv.textContent = "â€¦ AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...";
    messagesDiv.appendChild(loadingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    isSending = true;
    sendButton.disabled = true;

   try {
    const response = await fetch(MAKE_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            prompt: message,
            startDate: startDateForWebhook,
            endDate: endDateForWebhook,
            location: locationIds.join(","),
            locationIds,
            locationLabels,

            item: itemLabel,
            itemIds,
            itemColor,

            aiMode,
            aiModeLabels
        })
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â‘  ì‘ë‹µ ì›ë¬¸ì„ ë¨¼ì € ë¬¸ìì—´ë¡œ ë°›ê¸°
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const rawText = await response.text();

    // â‘¡ HTTP ìƒíƒœ ì½”ë“œ ì²´í¬ (200ëŒ€ê°€ ì•„ë‹ˆë©´ ì—ëŸ¬ ë˜ì§€ê¸°)
    if (!response.ok) {
        throw new Error(
            `HTTP ${response.status} ${response.statusText} / body: ${rawText}`
        );
    }

    // â‘¢ JSON íŒŒì‹± ì‹œë„
    let data;
    try {
        data = JSON.parse(rawText);
    } catch (e) {
        throw new Error(
            `ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. raw: ${rawText}`
        );
    }

    // â‘£ ìš°ë¦¬ê°€ ê¸°ëŒ€í•˜ëŠ” í‚¤ê°€ ì—†ì„ ë•Œë„ ì—ëŸ¬ë¡œ ì²˜ë¦¬
    if (!data || typeof data.response_text === "undefined") {
        throw new Error(
            `response_text í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì‘ë‹µ: ${rawText}`
        );
    }

    // ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ ì •ìƒ ì‘ë‹µ
    loadingDiv.remove();

    messagesDiv.innerHTML += `
        <div class="ai-message">ğŸ¤–: ${data.response_text}</div>
    `;


    } catch (err) {
    loadingDiv.remove();

    // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ë„ ìƒì„¸ ë¡œê·¸ ë‚¨ê¸°ê¸°
    console.error("ì›¹í›… í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);

    // í™”ë©´ì— ì—ëŸ¬ ë©”ì‹œì§€ ê°™ì´ í‘œì‹œ (HTML íƒœê·¸ ì´ìŠ¤ì¼€ì´í”„)
    const msg = (err && err.message ? err.message : String(err))
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;");

    messagesDiv.innerHTML += `
        <div class="ai-message bg-red-100 text-red-700 text-sm">
            âš ï¸ í†µì‹  ì˜¤ë¥˜: ${msg}
        </div>
    `;
}


    isSending = false;
    sendButton.disabled = false;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>

</body>
</html>
