<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/three-dots@0.3.2/dist/three-dots.min.css">
    <title>ERP-AI ì±—ë´‡</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        #messages {
            overflow-y: auto;
        }

        /* GPT ìŠ¤íƒ€ì¼ ì…ë ¥ë°” */
        .gpt-input-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #ffffff;
            border: 1px solid #e5e7eb;  /* gray-200~300 */
            border-radius: 9999px;
            padding: 6px 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        /* ì™¼ìª½ AI ëª¨ë“œ ë²„íŠ¼ (í”„ë¡¬í”„íŠ¸ ì•ˆ) */
        .gpt-left-btn {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            border: none;
            background: #f3f4f6;
            color: #374151;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            padding: 0 8px;
        }

        /* AI ëª¨ë“œ í† ê¸€ í™œì„±í™” ì‹œ */
        .ai-toggle-active {
            background-color: #0284c7 !important; /* sky-700 */
            border-color: #0284c7 !important;
            color: white !important;
        }

        /* ê°€ìš´ë° í”„ë¡¬í”„íŠ¸ ì…ë ¥ì°½ */
        .gpt-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            line-height: 1.4;
            padding: 10px 10px;
            min-height: 44px;
            max-height: 120px;
            background: transparent;
            scrollbar-width: none;
        }
        .gpt-input::-webkit-scrollbar {
            display: none;
        }

        /* ì˜¤ë¥¸ìª½ ì „ì†¡ ë²„íŠ¼ (ì›í˜•) */
        .gpt-send-btn {
            background: #4f46e5;    /* indigo-600 */
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(79,70,229,0.4);
        }
        .gpt-send-btn:disabled {
            background: #9ca3af; /* gray-400 */
            box-shadow: none;
        }

        /* í”„ë¡¬í”„íŠ¸ ì¤„ ì–‘ìª½ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ì§€ê¸ˆì€ ì‚¬ìš© ê±°ì˜ ì•ˆ í•˜ì§€ë§Œ ë‚¨ê²¨ë‘ ) */
        .prompt-bar-btn {
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }

        /* textarea ê¸°ë³¸ ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆ ì œê±° (gpt-inputì—ë„ ì ìš©) */
        textarea {
            scrollbar-width: none;      /* Firefox */
            -ms-overflow-style: none;   /* IE, Edge */
            overflow-y: auto;
            resize: none;
        }
        textarea::-webkit-scrollbar {
            display: none !important;   /* Chrome, Safari */
        }

        /* AI ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .ai-mode-active-textarea {
            background-color: #e0f2fe !important; /* sky-100 */
        }

        /* AI ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ ì „ì†¡ ë²„íŠ¼ ìƒ‰ */
        .ai-mode-active-button {
            background-color: #0284c7 !important; /* sky-700 */
        }

        /* ì˜¤ë¥¸ìª½ ì‚¬ìš©ì ë§í’ì„  */
        .user-message {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 4px 10px rgba(15,23,42,0.18);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* ì™¼ìª½ AI ë§í’ì„  */
        .ai-message {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin: 10px 10px;
            max-width: 100%;
            align-self: flex-start;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        #loading {
            font-size: 0.75rem;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .loading-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6; /* gray-100 */
            color: #4b5563;       /* gray-600 */
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 200px;
            font-size: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .loading-gif {
            width: 24px;
            height: 24px;
        }

        /* íŒŒì¼ì²¨ë¶€ìš© */
        .thumb {
          width: 56px;
          height: 56px;
          border-radius: 12px;
          object-fit: cover;
          border: 1px solid #e5e7eb;
        }
        .thumb-wrap {
          position: relative;
          display: inline-block;
          min-width: 56px;
          min-height: 56px;
          padding: 8px;
          background: #f9fafb; /* gray-50 */
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-direction: column;
        }
        .thumb-remove {
          position: absolute;
          top: -8px;
          right: -8px;
          width: 22px;
          height: 22px;
          border-radius: 9999px;
          border: 1px solid #e5e7eb;
          background: #fff;
          font-size: 12px;
          line-height: 20px;
          text-align: center;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        .drop-hint {
          outline: 2px dashed rgba(99,102,241,0.55);
          outline-offset: 4px;
        }
        .msg-attachments {
          margin-top: 8px;
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
        }
        
        .msg-attachments img {
          width: 64px;
          height: 64px;
          border-radius: 12px;
          object-fit: cover;
          border: 1px solid rgba(255,255,255,0.35); /* user bubble ëŒ€ë¹„ */
          cursor: pointer;
          transition: opacity 0.2s;
        }
        .msg-attachments img:hover {
            opacity: 0.8;
        }

        /* ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #modal-img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        #modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        #modal-close:hover {
            color: #bbb;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .stage {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 32px 0;
            margin: 0;
            overflow: hidden;
        }

        .dot-floating {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-floating 3s infinite cubic-bezier(0.15, 0.6, 0.9, 0.1);
        }
        @keyframes dot-floating {
            0% { left: calc(-50% - 5px); }
            75% { left: calc(50% + 105px); }
            100% { left: calc(50% + 105px); }
        }

        @media (max-width: 640px) {
            .gpt-input-bar {
                padding: 4px 8px;
                gap: 6px;
            }
            .gpt-left-btn {
                width: 28px;
                height: 28px;
                padding: 0 6px;
            }
            .gpt-send-btn {
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen">

<div class="flex h-screen">

    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <aside class="w-80 bg-white border-r flex flex-col">
        <div class="p-4 border-b">
            <h1 class="text-lg font-bold text-indigo-600">ERP-AI í•„í„°</h1>
            <p class="text-xs text-gray-500 mt-1">
                ERP ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ê°„, Location, Item, ì—…ì²´ëª…ì„ í†µí•´ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ì—¬ ê·¸ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ AIë¶„ì„ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">
            <section class="mb-3">
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ì—”ì§„ ì„ íƒ</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-engine" value="gemini" data-label="Gemini" checked>
                        <span>Gemini</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-engine" value="gpt" data-label="GPT" >
                        <span>GPT</span>
                    </label>
                </div>
            </section>

            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ë¶„ì„ ëª¨ë“œ</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-mode" value="erp" data-label="ERP-AI ë¶„ì„" checked>
                        <span>ERP-AI ë¶„ì„</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="ai-mode" value="ai" data-label="AI ê²€ìƒ‰">
                        <span>AI ê²€ìƒ‰</span>
                    </label>
                </div>
            </section>

            <section id="period-section">
                <h2 class="text-xs font-semibold text-gray-600 mb-2">ê¸°ê°„ ì„ íƒ</h2>
                <div class="space-y-2">
                    <label class="text-xs">ì‹œì‘ì¼(ERP ë°ì´í„°: 2024-04-01 ë¶€í„°)</label>
                    <input type="date" id="start-date" class="w-full p-2 border border-gray-300 rounded-lg">
                    <label class="text-xs">ì¢…ë£Œì¼</label>
                    <input type="date" id="end-date" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <p id="sheet-update-display" class="text-xs text-gray-600 mb-1 text-center leading-relaxed whitespace-pre-line"></p>
            </section>

            <section id="erp-options-section" class="space-y-4">
                <div id="erp-location-section">
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Location</h2>
                    <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                        <label class="flex items-center space-x-2 font-semibold">
                            <input type="checkbox" id="location-all" class="location-master">
                            <span>ëª¨ë‘ ì„ íƒ</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1007" data-label="SEA">
                            <span>SEA</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1008" data-label="SEG">
                            <span>SEG</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1006" data-label="SEMA">
                            <span>SEMA</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="location-checkbox" value="1005" data-label="SEMS">
                            <span>SEMS</span>
                        </label>
                    </div>
                </div>

                <div id="erp-item-section" class="space-y-4">
                    <div>
                        <h2 class="text-xs font-semibold text-gray-600 mb-2">Item (ì œí’ˆëª…,ì œí’ˆì†ì„±)</h2>
                        <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                            <label class="flex items-center space-x-2 font-semibold">
                                <input type="checkbox" id="item-all" class="item-master">
                                <span>ëª¨ë‘ ì„ íƒ</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="LABEL">
                                <span>Label</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="RIBBON">
                                <span>Ribbon</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="item-checkbox" value="FILM">
                                <span>Film</span>
                            </label>
                            <div class="space-y-1 pt-1">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="item-custom-toggle">
                                    <span><input type="text" id="item-color-input" placeholder="ì—¬ëŸ¬ê°’ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„" class="w-full p-2 border border-gray-300 rounded-lg"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Project</h2>
                    <button id="projectDropdownBtn" class="w-full p-2 border border-gray-300 rounded-lg flex justify-between items-center bg-white">
                        <span id="projectDropdownLabel">Project</span>
                        <span>â–¼</span>
                    </button>
                    <div id="projectDropdownMenu" class="absolute left-0 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden z-20">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P001" data-label="êµ¬ë§¤ëŒ€í–‰">
                            <span>MRO êµ¬ë§¤ëŒ€í–‰ General Purchasing</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P018" data-label="ê²½ë¹„">
                            <span>ê²½ë¹„ Security</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P020" data-label="ë³´ì „">
                            <span>ë³´ì „ Maintenance Management</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P011" data-label="ìƒê´€ ë¬¼ë¥˜">
                            <span>ìƒê´€ ë¬¼ë¥˜ Transportation Shipping</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P008" data-label="ìƒì‚°ì§€ì›">
                            <span>ìƒì‚°ì§€ì› Production Service</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P009" data-label="ì¸ë ¥ê³µê¸‰">
                            <span>ì¸ë ¥ê³µê¸‰ Staffing</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P016" data-label="ìì‚°ê´€ë¦¬">
                            <span>ìì‚°ê´€ë¦¬ Property Management</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P013" data-label="ìì¬ ë¬¼ë¥˜">
                            <span>ìì¬ ë¬¼ë¥˜ Transportation Material</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P010" data-label="ì¥ë¹„ì„ëŒ€">
                            <span>ì¥ë¹„ì„ëŒ€ Equipment Lease</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P002" data-label="ì²­ì†Œ">
                            <span>ì²­ì†Œ Janitorial</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P017" data-label="ì¼€ì´í„°ë§">
                            <span>ì¼€ì´í„°ë§ Catering</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="project-checkbox" value="P019" data-label="íê¸°ë¬¼ ì²˜ë¦¬ ëŒ€í–‰">
                            <span>íê¸°ë¬¼ ì²˜ë¦¬ ëŒ€í–‰ Waste Management</span>
                        </label>
                    </div>
                </div>

                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">ì—…ì²´ëª…</h2>
                    <input type="text" id="SupplierName" placeholder="ì—¬ëŸ¬ê°’ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Invoice No</h2>
                    <input type="text" id="InvoiceNo" placeholder="ì—¬ëŸ¬ê°’ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>

                <div id="critique-btn-wrapper">
                    <button id="critique-btn" onclick="requestCritique()" class="w-full p-3 bg-green-500 text-white rounded-lg font-bold shadow-md hover:bg-green-600 transition duration-150 disabled:bg-gray-400">
                        âœ¨ ë°ì´í„° í•„í„° Critique (Gemini)
                    </button>
                </div>
            </section>
        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <main class="flex-1 flex flex-col">
        <header class="h-14 px-6 flex items-center border-b bg-white">
            <div>
                <h2 class="text-base font-semibold">NOVA INTEGRATED SOLUTIONS LLC</h2>
                <p class="text-sm text-gray-500">êµ¬ë§¤ì´ë ¥ì„ AI í†µí•´ ì¡°íšŒ ë° ë¶„ì„í•˜ê³  AI ê²€ìƒ‰ì„ ìœ„í•œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</p>
            </div>
        </header>

        <section id="messages" class="flex-1 flex flex-col p-4 space-y-3 bg-white">
            <div class="ai-message">ğŸª„ ì•ˆë…•í•˜ì„¸ìš”! AI ë¶„ì„ ëª¨ë“œë¥¼ ì„ íƒí•˜ê±°ë‚˜, ERP ë°ì´í„° ê²€ìƒ‰ì„ ìœ„í•œ í•„í„°ë¥¼ ì„ íƒí•˜ê³  ì•„ë˜ì— ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </section>

        <section class="bg-white p-4">
            <div class="max-w-3xl mx-auto space-y-2">
                <section id="preset-prompt-wrapper">
                    <select id="preset-prompt" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
                        <option value="">-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ (ì„ íƒ ì•ˆí•¨) --</option>
                        <option value="ì£¼ì–´ì§„ ê°’ìœ¼ë¡œ ì¡°íšŒëœ ë°ì´í„° ê²°ê³¼ë¥¼ ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ í‘œë¡œ ì •ë¦¬">ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ë¥¼ í‘œë¡œ ì •ë¦¬</option>
                        <option value="í•´ë‹¹ ê¸°ê°„ ë° Locationì—ì„œ Taxì™€ Shpping feeë¥¼ ì œì™¸í•˜ê³  ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆ ìˆœìœ„ 10ê°œë¥¼ ìˆœìœ„, itemì´ë¦„, ì´ê¸ˆì•¡, êµ¬ë§¤íšŸìˆ˜ë¡œ ë³´ì—¬ì¤˜">í•´ë‹¹ ê¸°ê°„ ë° Lacationì—ì„œ ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆ ìˆœìœ„ 10ê°œ</option>
                        <option value="ë‹¨ê°€ ë¹„êµë¥¼ ì—…ì²´ëª…, ì•„ì´í…œëª…, ë‹¨ê°€ë¥¼ ë‹¨ê°€ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ í‘œë¡œ ì‘ì„±">ë‹¨ê°€ ë¹„êµë¥¼ ì—…ì²´ëª…, ì•„ì´í…œëª…, ë‹¨ê°€ í‘œë¡œ ì‘ì„±</option>
                    </select>
                </section>

                <div class="gpt-input-bar">
                    <button id="ai-search-toggle" class="gpt-left-btn">AIëª¨ë“œ</button>
                    <button id="attach-btn" type="button" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 transition duration-150" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</button>
                    <textarea id="user-input" placeholder="í•„í„°ë¥¼ ì„ íƒí•˜ê³  AIì—ê²Œ ì›í•˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="gpt-input" rows="1" oninput="autoResize(this)"></textarea>
                    <button onclick="sendMessage()" id="send-button" class="gpt-send-btn">â¤</button>
                </div>
                
                <input id="file-input" type="file" accept="*/*" multiple class="hidden" />
                <div id="attachment-preview" class="msg-attachments"></div>
            </div>
        </section>
    </main>
</div>

<!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
<div id="image-modal" onclick="closeImageModal()">
    <span id="modal-close">&times;</span>
    <img id="modal-img" alt="Zoomed Image">
</div>

<script>
// --- ì „ì—­ ìƒìˆ˜ ---
const MAX_FILES = 3;
const MAX_TOTAL_BYTES = 10 * 1024 * 1024;
const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq";

window.currentEngine = null;
window.lastEngine = null;
let responseId = null;
let conversationId = null;

// ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ í•¨ìˆ˜
function openImageModal(src) {
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-img');
    modal.style.display = "flex";
    modalImg.src = src;
}

function closeImageModal() {
    document.getElementById('image-modal').style.display = "none";
}

function resetConversationState() {
    window.conversationId = null;
    window.responseId = null;
}

const engineRadios = document.querySelectorAll('input[name="ai-engine"]');
engineRadios.forEach(r => {
    r.addEventListener('change', () => {
        resetConversationState();
        resetPromptArea();
        updateCritiqueButtonVisibility();
    });
});

function updateCritiqueButtonVisibility() {
    const selectedEngine = document.querySelector('input[name="ai-engine"]:checked')?.value;
    const critiqueWrapper = document.getElementById('critique-btn-wrapper');
    if (critiqueWrapper) {
        critiqueWrapper.classList.toggle('hidden', selectedEngine !== 'gemini');
    }
}

function autoResize(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
}

const SHEET_LAST_UPDATE_URL = "https://hook.us2.make.com/3xywupvm8a60lrh5l1l6kwpqe4sjake1";
async function setEndDateFromSheet() {
    const endInput = document.getElementById("end-date");
    const startInput = document.getElementById("start-date");
    const display = document.getElementById("sheet-update-display");

    try {
        const res = await fetch(SHEET_LAST_UPDATE_URL);
        const data = await res.json();
        const endStr = data.lastUpdatedDate;
        if (!endStr || !endInput || !startInput) return;
        endInput.value = endStr;
        const endDateObj = parseHtmlDate(endStr);
        const start = new Date(endDateObj);
        start.setMonth(start.getMonth() - 1);
        startInput.value = formatHtmlDate(start);
        if (display) display.textContent = `ğŸ“Œ ERP ìµœì‹  ì—…ë°ì´íŠ¸ ë‚ ì§œ: ${data.lastUpdatedText || endStr}`;
    } catch (e) {
        console.error("ì—…ë°ì´íŠ¸ ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
        const today = new Date();
        if (endInput) endInput.value = formatHtmlDate(today);
        const start = new Date(today);
        start.setMonth(start.getMonth() - 1);
        if (startInput) startInput.value = formatHtmlDate(start);
    }
}

function collectFilterData() {
    const startDateValue = document.getElementById("start-date").value;
    const endDateValue = document.getElementById("end-date").value;
    const locBoxes = document.querySelectorAll(".location-checkbox:checked");
    const itemBoxes = document.querySelectorAll(".item-checkbox:checked");
    const projectBoxes = document.querySelectorAll(".project-checkbox:checked");

    return {
        startDate: startDateValue ? formatDisplayDate(parseHtmlDate(startDateValue)) : '',
        endDate: endDateValue ? formatDisplayDate(parseHtmlDate(endDateValue)) : '',
        location: Array.from(locBoxes).map(cb => cb.dataset.label).join(", ") || 'ALL Locations',
        itemNames: Array.from(itemBoxes).map(cb => cb.value).join(", ") || 'ALL Items (Checked)',
        itemCustom: document.getElementById("item-color-input").value.trim() || 'None',
        projects: Array.from(projectBoxes).map(cb => cb.dataset.label.trim()).join(", ") || 'ALL Projects',
        supplier: document.getElementById("SupplierName").value.trim() || 'ALL Suppliers',
        invoice: document.getElementById("InvoiceNo").value.trim() || 'None'
    };
}

function requestCritique() {
    const filters = collectFilterData();
    const critiquePrompt = `Critique the currently selected ERP filter set for meaningful analysis and suggest deep-dive questions.

    --- Current Filters ---
    1. Period: ${filters.startDate} to ${filters.endDate}
    2. Location(s): ${filters.location}
    3. Item Names (Checkboxes): ${filters.itemNames}
    4. Item Custom Filter (Text): ${filters.itemCustom}
    5. Projects: ${filters.projects}
    6. Supplier Name: ${filters.supplier}
    7. Invoice No: ${filters.invoice}
    
    Based on these specific filters, suggest a focused analysis or point out any potential data integrity issues (e.g., if the time range is too long, or conflicting filters are applied).
    `;
    const inputElement = document.getElementById('user-input');
    if (inputElement) {
        inputElement.value = critiquePrompt;
        autoResize(inputElement);
    }
    sendMessage();
}

function formatHtmlDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function formatDisplayDate(date) {
    return `${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}/${date.getFullYear()}`;
}
function parseHtmlDate(str) {
    if (!str) return new Date();
    const [y,m,d] = str.split("-").map(Number);
    return new Date(y, m - 1, d);
}

function setupMasterCheckbox(masterSelector, itemSelector) {
    const master = document.querySelector(masterSelector);
    const items = document.querySelectorAll(itemSelector);
    if (!master || items.length === 0) return;
    master.addEventListener("change", () => items.forEach(cb => cb.checked = master.checked));
    items.forEach(cb => {
        cb.addEventListener("change", () => {
            master.checked = Array.from(items).every(x => x.checked);
        });
    });
}

function getCurrentAiMode() {
    return document.querySelector('input[name="ai-mode"]:checked')?.value;
}

function updateErpVisibility() {
    const mode = getCurrentAiMode();
    const isErp = (mode === 'erp');
    ['period-section', 'erp-options-section', 'preset-prompt-wrapper'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('hidden', !isErp);
    });
}

function updateAiModeStyling() {
    const aiMode = getCurrentAiMode();
    const textarea = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    textarea.classList.toggle("ai-mode-active-textarea", aiMode === "ai");
    sendButton.classList.toggle("ai-mode-active-button", aiMode === "ai");
}

function resetPromptArea() {
    const textarea = document.getElementById("user-input");
    if (textarea) { textarea.value = ""; autoResize(textarea); }
}

function updatePromptPlaceholder() {
    const textarea = document.getElementById("user-input");
    const aiMode = getCurrentAiMode();
    if (!textarea) return;
    textarea.placeholder = aiMode === "erp" ? "í•„í„°ë¥¼ ì„ íƒí•˜ê³  AIì—ê²Œ ì›í•˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." : "ë¬´ì—‡ì´ë“  ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.";
}

const projectBtn = document.getElementById("projectDropdownBtn");
const projectMenu = document.getElementById("projectDropdownMenu");
projectBtn.addEventListener("click", () => projectMenu.classList.toggle("hidden"));
document.addEventListener("click", (e) => {
    if (!projectBtn.contains(e.target) && !projectMenu.contains(e.target)) projectMenu.classList.add("hidden");
});

document.addEventListener("DOMContentLoaded", () => {
    setupMasterCheckbox("#location-all", ".location-checkbox");
    setupMasterCheckbox("#item-all", ".item-checkbox");
    const presetSelect = document.getElementById("preset-prompt");
    const userInput = document.getElementById("user-input");
    if (presetSelect && userInput) {
        presetSelect.addEventListener("change", () => {
            userInput.value = presetSelect.value;
            autoResize(userInput);
        });
    }

    userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    const aiToggleBtn = document.getElementById('ai-search-toggle');
    const aiRadios = document.querySelectorAll('input[name="ai-mode"]');
    if (aiToggleBtn) {
        aiToggleBtn.addEventListener('click', () => {
            const isActive = aiToggleBtn.classList.toggle('ai-toggle-active');
            const targetRadio = document.querySelector(`input[name="ai-mode"][value="${isActive ? 'ai' : 'erp'}"]`);
            if (targetRadio) targetRadio.checked = true;
            updateErpVisibility(); updateAiModeStyling(); updatePromptPlaceholder(); updateCritiqueButtonVisibility(); resetPromptArea();
        });
        aiRadios.forEach(r => r.addEventListener('change', () => {
            aiToggleBtn.classList.toggle('ai-toggle-active', r.value === 'ai' && r.checked);
            updateErpVisibility(); updateAiModeStyling(); updatePromptPlaceholder(); updateCritiqueButtonVisibility(); resetPromptArea();
        }));
    }

    const updateProjectLabel = () => {
        const checked = document.querySelectorAll(".project-checkbox:checked");
        const labels = Array.from(checked).map(cb => cb.dataset.label || cb.value);
        if (labels.length > 2) { event.target.checked = false; alert("í”„ë¡œì íŠ¸ëŠ” ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
        document.getElementById("projectDropdownLabel").textContent = labels.length ? labels.join(", ") : "Project";
    };
    document.querySelectorAll(".project-checkbox").forEach(el => el.addEventListener("change", updateProjectLabel));

    setEndDateFromSheet(); updateErpVisibility(); updateAiModeStyling(); updateCritiqueButtonVisibility(); autoResize(userInput);
});

window.attachedImages = [];

function renderAttachments() {
    const wrap = document.getElementById("attachment-preview");
    if (!wrap) return;
    wrap.innerHTML = "";
    window.attachedImages.forEach((file, idx) => {
        const url = URL.createObjectURL(file);
        const item = document.createElement("div");
        item.className = "thumb-wrap";
        let contentHtml = file.type.startsWith("image/") ? `<img src="${url}" class="thumb" />` : 
            `<div class="flex flex-col items-center justify-center h-full"><span class="text-xs font-bold text-gray-500">${file.name.split('.').pop().toUpperCase()}</span></div>`;
        item.innerHTML = `${contentHtml}<button type="button" class="thumb-remove" onclick="removeAttachment(${idx})">Ã—</button>`;
        wrap.appendChild(item);
    });
}

function removeAttachment(idx) {
    window.attachedImages.splice(idx, 1);
    renderAttachments();
}

function addImageFiles(files) {
    const arr = Array.from(files || []).filter(f => f);
    if (!arr.length) return;
    const remain = MAX_FILES - window.attachedImages.length;
    if (remain <= 0) { pushWarn(`ì²¨ë¶€ íŒŒì¼ì€ ìµœëŒ€ ${MAX_FILES}ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`); return; }
    const finalCandidates = arr.slice(0, remain);
    let currentSize = window.attachedImages.reduce((s, f) => s + f.size, 0);
    const accepted = [];
    for (const f of finalCandidates) {
        if (currentSize + f.size > MAX_TOTAL_BYTES) { pushWarn("ì´ ì²¨ë¶€ ìš©ëŸ‰ 10MBë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."); break; }
        accepted.push(f);
        currentSize += f.size;
    }
    window.attachedImages = window.attachedImages.concat(accepted);
    renderAttachments();
}

document.getElementById("attach-btn").onclick = () => document.getElementById("file-input").click();
document.getElementById("file-input").onchange = (e) => { addImageFiles(e.target.files); e.target.value = ""; };

async function readFileAsDataURL(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
    });
}

function pushWarn(text) {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML += `<div class="ai-message bg-yellow-50 text-yellow-700">âš ï¸ ${text}</div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

let isSending = false;
async function sendMessage() {
    const textarea = document.getElementById("user-input");
    const messagesDiv = document.getElementById("messages");
    const sendButton = document.getElementById("send-button");
    const message = textarea.value.trim();

    if (!message || isSending) return;

    const filterData = collectFilterData();
    const locBoxes = document.querySelectorAll(".location-checkbox:checked");
    const itemBoxes = document.querySelectorAll(".item-checkbox:checked");
    const projectBoxes = document.querySelectorAll(".project-checkbox:checked");

    isSending = true;
    sendButton.disabled = true;

    // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ (ì´ë¯¸ì§€ í™•ëŒ€ ê¸°ëŠ¥ ì ìš©)
    const attachmentParts = await Promise.all(window.attachedImages.map(async (file) => {
        if (file.type.startsWith("image/")) {
            const base64Data = await readFileAsDataURL(file);
            return `<img src="${base64Data}" onclick="openImageModal('${base64Data}')" alt="attachment" />`;
        }
        return `<div class="w-16 h-16 rounded-lg bg-indigo-700 flex flex-col items-center justify-center p-1"><span class="text-xs text-white truncate w-full text-center">${file.name.substring(0, 10)}</span></div>`;
    }));
    
    messagesDiv.innerHTML += `
      <div class="user-message">
        ${message}
        <div class="msg-attachments">${attachmentParts.join("")}</div>
      </div>
    `;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    textarea.value = ""; autoResize(textarea);
    const loadingDiv = document.createElement("div");
    loadingDiv.id = "loading";
    loadingDiv.innerHTML = `<div class="stage"><div class="dot-floating"></div></div>`;
    messagesDiv.appendChild(loadingDiv);

    try {
        const body = {
            prompt: message,
            startDate: document.getElementById('start-date').value,
            endDate: document.getElementById('end-date').value,
            location: Array.from(locBoxes).map(cb => cb.value).join(","),
            item: Array.from(itemBoxes).map(cb => cb.value).join(","),
            itemColor: document.getElementById("item-color-input").value.trim(),
            aiMode: getCurrentAiMode(),
            SupplierName: document.getElementById("SupplierName").value.trim(),
            InvoiceNo: document.getElementById("InvoiceNo").value.trim(),
            ProjectCode: Array.from(projectBoxes).map(cb => cb.value).join(","),
            aiEngine: document.querySelector('input[name="ai-engine"]:checked')?.value,
            conversationId: window.conversationId,
            responseId: window.responseId
        };

        const formData = new FormData();
        Object.entries(body).forEach(([k, v]) => formData.append(k, v ?? ""));
        window.attachedImages.forEach((file, idx) => formData.append("files", file, file.name || `file-${idx}`));

        const response = await fetch(MAKE_WEBHOOK_URL, { method: "POST", body: formData });
        const rawText = await response.text();

        responseId = response.headers.get("ResponseID");
        conversationId = response.headers.get("ConversationID");

        loadingDiv.remove();
        messagesDiv.innerHTML += `<div class="ai-message">ğŸª„ ${rawText}</div>`;

    } catch (err) {
        loadingDiv.remove();
        console.error("Error:", err);
        messagesDiv.innerHTML += `<div class="ai-message bg-red-50 text-red-700">âš ï¸ ì˜¤ë¥˜: ${err.message}</div>`;
    } finally {
        if (conversationId) window.conversationId = conversationId;
        if (responseId) window.responseId = responseId;
        sendButton.disabled = false;
        window.attachedImages = [];
        renderAttachments();
        isSending = false;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
}
</script>

</body>
</html>
