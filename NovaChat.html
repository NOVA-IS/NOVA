<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP-Gemini ì±—ë´‡</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        #messages {
            overflow-y: auto;
        }
        .user-message {
            @apply bg-indigo-500 text-white p-3 rounded-lg shadow-md mb-2 max-w-3xl self-end ml-auto;
        }
        .ai-message {
            @apply bg-gray-100 text-gray-800 p-3 rounded-lg shadow-md mb-2 max-w-3xl self-start mr-auto;
        }
        #loading {
            @apply text-sm text-gray-500 italic mb-2;
        }
        .input-group-container {
            @apply flex flex-col space-y-1;
        }
        .input-label {
            @apply text-xs font-semibold text-gray-600;
        }
        .input-field-no-label {
            @apply flex flex-col;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen">

<div class="flex h-screen">

    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°”: í•„í„° ì˜µì…˜ë“¤ -->
    <aside class="w-80 bg-white border-r flex flex-col">
        <div class="p-4 border-b">
            <h1 class="text-lg font-bold text-indigo-600">ERP-Gemini í•„í„°</h1>
            <p class="text-xs text-gray-500 mt-1">
                ê¸°ê°„, Location, Item, AI ëª¨ë“œë¥¼ ì„ íƒí•œ ë’¤ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.
            </p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">

            <!-- ë‚ ì§œ ë²”ìœ„ -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">ê¸°ê°„ ì„ íƒ</h2>
                <div class="space-y-2">
                    <div class="input-group-container">
                        <label for="start-date" class="input-label">ì‹œì‘ì¼</label>
                        <input type="date" id="start-date"
                               class="p-2 border border-gray-300 rounded-lg"
                               title="ì‹œì‘ì¼">
                    </div>
                    <div class="input-group-container">
                        <label for="end-date" class="input-label">ì¢…ë£Œì¼</label>
                        <input type="date" id="end-date"
                               class="p-2 border border-gray-300 rounded-lg"
                               title="ì¢…ë£Œì¼">
                    </div>
                </div>
            </section>

            <!-- Location -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">Location</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                    <!-- ëª¨ë‘ ì„ íƒ -->
                    <label class="flex items-center space-x-2 font-semibold">
                        <input type="checkbox" id="location-all" class="location-master">
                        <span>ëª¨ë‘ ì„ íƒ</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1007" data-label="SEA">
                        <span>SEA</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1008" data-label="SEG">
                        <span>SEG</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1006" data-label="SEMA">
                        <span>SEMA</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="location-checkbox" value="1005" data-label="SEMS">
                        <span>SEMS</span>
                    </label>
                </div>
            </section>

            <!-- Item -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">Item (ì œí’ˆëª…)</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                    <!-- ëª¨ë‘ ì„ íƒ -->
                    <label class="flex items-center space-x-2 font-semibold">
                        <input type="checkbox" id="item-all" class="item-master">
                        <span>ëª¨ë‘ ì„ íƒ</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="item-checkbox" value="Label">
                        <span>Label</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="item-checkbox" value="Ribbon">
                        <span>Ribbon</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="item-checkbox" value="Film">
                        <span>Film</span>
                    </label>
                </div>
            </section>

            <!-- Item Color -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">Item Color (ì œí’ˆ ìƒ‰ìƒ)</h2>
                <input type="text" id="item-color-input"
                       placeholder="ì˜ˆ: Black, White..."
                       class="w-full p-2 border border-gray-300 rounded-lg"
                       title="Item Color (ì œí’ˆ ìƒ‰ìƒ)">
            </section>

            <!-- AI ë¶„ì„ ëª¨ë“œ -->
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ë¶„ì„ ëª¨ë“œ</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">
                    <!-- ëª¨ë‘ ì„ íƒ -->
                    <label class="flex items-center space-x-2 font-semibold">
                        <input type="checkbox" id="ai-all" class="ai-master">
                        <span>ëª¨ë‘ ì„ íƒ</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="ai-mode-checkbox" value="erp" data-label="ERP ë¶„ì„">
                        <span>ERP ë¶„ì„</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="ai-mode-checkbox" value="ai" data-label="AI ì„œì¹˜">
                        <span>AI ì„œì¹˜</span>
                    </label>
                </div>
            </section>

        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <main class="flex-1 flex flex-col">

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="h-14 px-6 flex items-center border-b bg-white">
            <div>
                <h2 class="text-base font-semibold">ERP-Gemini ì±—ë´‡</h2>
                <p class="text-xs text-gray-500">
                    ì™¼ìª½ì—ì„œ ì¡°ê±´ì„ ì„ íƒí•˜ê³  ì•„ë˜ì—ì„œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.
                </p>
            </div>
        </header>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <section id="messages" class="flex-1 flex flex-col p-4 space-y-3 bg-gray-50">
            <div class="ai-message">
                ğŸ¤– ì•ˆë…•í•˜ì„¸ìš”! ì™¼ìª½ì—ì„œ ê¸°ê°„, Location, Item, AI ëª¨ë“œë¥¼ ì„ íƒí•œ ë’¤<br>
                ì•„ë˜ì— ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ë˜ëŠ” ì§ì ‘ ì…ë ¥í•œ ì§ˆë¬¸ìœ¼ë¡œ ë¶„ì„ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </section>

        <!-- ì…ë ¥ ì˜ì—­ (í™”ë©´ ê°€ìš´ë° ì•„ë˜) -->
        <section class="border-t bg-white p-4">
            <div class="max-w-3xl mx-auto space-y-3">

                <!-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ -->
                <select id="preset-prompt"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                    <option value="">-- ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ ì„ íƒ (ì„ íƒ ì•ˆí•¨) --</option>
                    <option value="í•´ë‹¹ ê¸°ê°„ ë° ì§€ì—­ì—ì„œ ê°€ì¥ ë§ì´ íŒ”ë¦° ì œí’ˆì€?">
                        í•´ë‹¹ ê¸°ê°„ ë° ì§€ì—­ì—ì„œ ê°€ì¥ ë§ì´ êµ¬ë§¤í•œ ì œí’ˆì€?
                    </option>
                    <option value="ë‹¨ê°€ ë¹„êµ í‘œ ì‘ì„±">ë‹¨ê°€ ë¹„êµ í‘œ ì‘ì„±</option>
                </select>
                
                <!-- í”„ë¡¬í”„íŠ¸ + ì „ì†¡ ë²„íŠ¼ -->
                <div class="flex space-x-3">
                    <input type="text" id="user-input"
                           placeholder="ë˜ëŠ” ì—¬ê¸°ì— ì§ì ‘ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                           onkeypress="if(event.keyCode === 13) sendMessage()">
                    <button onclick="sendMessage()" id="send-button"
                            class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-gray-400 text-sm">
                        ì „ì†¡
                    </button>
                </div>
            </div>
        </section>

    </main>
</div>

<script>
    // â­ Make Webhook URL
    const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq"; 
    
    let isSending = false;

    // HTML date input ê¸°ë³¸ê°’ ì„¤ì •ìš© (YYYY-MM-DD)
    function formatHtmlDate(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // í™”ë©´ì— í‘œì‹œìš© ë‚ ì§œ (MM/DD/YYYY)
    function formatDisplayDate(date) {
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${mm}/${dd}/${yyyy}`;
    }

    // ì›¹í›… ì „ì†¡ìš© ë‚ ì§œ (MMDDYYYY)
    function formatWebhookDate(date) {
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${mm}${dd}${yyyy}`;
    }

    // "YYYY-MM-DD" â†’ Date ê°ì²´
    function parseHtmlDate(str) {
        if (!str) return null;
        const parts = str.split('-'); // [yyyy, mm, dd]
        if (parts.length !== 3) return null;
        const [yyyy, mm, dd] = parts;
        return new Date(parseInt(yyyy, 10), parseInt(mm, 10) - 1, parseInt(dd, 10));
    }

    // â­ ê³µí†µ ê¸°ëŠ¥: ë§ˆìŠ¤í„° ì²´í¬ë°•ìŠ¤ ì œì–´ í•¨ìˆ˜
    function setupMasterCheckbox(masterSelector, itemSelector) {
        const master = document.querySelector(masterSelector);
        const items = document.querySelectorAll(itemSelector);

        if (!master || items.length === 0) return;

        // ëª¨ë‘ ì„ íƒ í´ë¦­ ì‹œ ì „ì²´ í† ê¸€
        master.addEventListener("change", () => {
            items.forEach(cb => cb.checked = master.checked);
        });

        // ê°œë³„ ì²´í¬ ì‹œ ë§ˆìŠ¤í„° ì²´í¬ ì—…ë°ì´íŠ¸
        items.forEach(cb => {
            cb.addEventListener("change", () => {
                const allChecked = Array.from(items).every(x => x.checked);
                master.checked = allChecked;
            });
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¤ì •
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        document.getElementById('end-date').value = formatHtmlDate(today);
        document.getElementById('start-date').value = formatHtmlDate(oneYearAgo);

        // ë§ˆìŠ¤í„° ì²´í¬ë°•ìŠ¤ë“¤ ì´ˆê¸°í™”
        setupMasterCheckbox('#location-all', '.location-checkbox');
        setupMasterCheckbox('#item-all', '.item-checkbox');
        setupMasterCheckbox('#ai-all', '.ai-mode-checkbox');
    });

    async function sendMessage() {
        const inputElement = document.getElementById('user-input');
        const selectElement = document.getElementById('preset-prompt');
        const sendButton = document.getElementById('send-button');
        const messagesDiv = document.getElementById('messages');
        
        // 1. ìµœì¢… ì§ˆë¬¸
        const presetMessage = selectElement.value;
        const typedMessage = inputElement.value.trim();
        const message = presetMessage || typedMessage;

        // 2. ë‚ ì§œ ë°ì´í„° ìˆ˜ì§‘
        const startDateValue = document.getElementById('start-date').value; // YYYY-MM-DD
        const endDateValue = document.getElementById('end-date').value;     // YYYY-MM-DD

        const startDateObj = parseHtmlDate(startDateValue);
        const endDateObj = parseHtmlDate(endDateValue);

        // í™”ë©´ í‘œì‹œìš©ì€ MM/DD/YYYY
        const startDateDisplay = startDateObj ? formatDisplayDate(startDateObj) : '';
        const endDateDisplay = endDateObj ? formatDisplayDate(endDateObj) : '';

        // ì›¹í›… ì „ì†¡ìš©ì€ MMDDYYYY
        const startDateForWebhook = startDateObj ? formatWebhookDate(startDateObj) : '';
        const endDateForWebhook = endDateObj ? formatWebhookDate(endDateObj) : '';

        // Location ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        const checkedLocationBoxes = document.querySelectorAll('.location-checkbox:checked');
        const locationIds = Array.from(checkedLocationBoxes).map(cb => cb.value);
        const locationLabels = Array.from(checkedLocationBoxes).map(cb => cb.dataset.label);

        // Item ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        const checkedItemBoxes = document.querySelectorAll('.item-checkbox:checked');
        const itemIds = Array.from(checkedItemBoxes).map(cb => cb.value);
        const itemLabel = itemIds.join(', ');

        const itemColorInput = document.getElementById('item-color-input').value.trim();

        // AI ëª¨ë“œ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        const checkedAiMode = document.querySelectorAll('.ai-mode-checkbox:checked');
        const aiMode = Array.from(checkedAiMode).map(cb => cb.value);              // ["erp","ai"]
        const aiModeLabels = Array.from(checkedAiMode).map(cb => cb.dataset.label); // ["ERP ë¶„ì„","AI ì„œì¹˜"]

        // 3. ìœ íš¨ì„± ê²€ì‚¬
        if (!message || isSending) {
            if (!message && !isSending) {
                messagesDiv.innerHTML += `<div class="ai-message self-start bg-yellow-100 text-yellow-700">âš ï¸ ì˜¤ë¥˜: ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¯¸ë¦¬ ì •ì˜ëœ ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
            return;
        }

        // 4. ì „ì†¡ ìƒíƒœ
        isSending = true;
        sendButton.disabled = true;

        // 5. ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ (í•„í„° í‘œì‹œ)
        let displayMessage = message;
        let filterDetails = [];
        if (startDateDisplay) filterDetails.push(`ì‹œì‘ì¼: ${startDateDisplay}`);
        if (endDateDisplay) filterDetails.push(`ì¢…ë£Œì¼: ${endDateDisplay}`);
        if (locationLabels.length > 0) filterDetails.push(`Location: ${locationLabels.join(', ')}`);
        if (itemLabel) filterDetails.push(`Item: ${itemLabel}`);
        if (itemColorInput) filterDetails.push(`Item Color: ${itemColorInput}`);
        if (aiModeLabels.length > 0) filterDetails.push(`AI ëª¨ë“œ: ${aiModeLabels.join(', ')}`);

        if (filterDetails.length > 0) {
            displayMessage += `<br><span class="text-xs opacity-80">(í•„í„°: ${filterDetails.join(', ')})</span>`;
        }

        messagesDiv.innerHTML += `<div class="user-message self-end">${displayMessage}</div>`;
        inputElement.value = '';
        selectElement.value = '';

        // 6. ë¡œë”© ë©”ì‹œì§€
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading';
        loadingDiv.textContent = '... AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
        messagesDiv.appendChild(loadingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 

        try {
            // 7. ì›¹í›… ì „ì†¡ (ë‚ ì§œ = MMDDYYYY)
            const response = await fetch(MAKE_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: message,
                    startDate: startDateForWebhook,
                    endDate: endDateForWebhook,

                    // Location ë‹¤ì¤‘ ì„ íƒ
                    location: locationIds.join(','),
                    locationIds: locationIds,
                    locationLabels: locationLabels,

                    // Item ë‹¤ì¤‘ ì„ íƒ
                    item: itemLabel,
                    itemLabel: itemLabel,
                    itemIds: itemIds,

                    // ê¸°íƒ€ í•„í„°
                    itemColor: itemColorInput,

                    // AI ëª¨ë“œ
                    aiMode: aiMode,
                    aiModeLabels: aiModeLabels
                })
            });

            const data = await response.json();
            
            const currentLoadingDiv = document.getElementById('loading');
            if (currentLoadingDiv) currentLoadingDiv.remove();

            let responseText = data.response_text || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Make ì‹œë‚˜ë¦¬ì˜¤ì˜ Webhook Response ëª¨ë“ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            messagesDiv.innerHTML += `<div class="ai-message self-start">ğŸ¤–: ${responseText}</div>`;
            
        } catch (error) {
            console.error("Fetch Error:", error);
            
            const currentLoadingDiv = document.getElementById('loading');
            if (currentLoadingDiv) currentLoadingDiv.remove();
            
            messagesDiv.innerHTML += `<div class="ai-message self-start bg-red-100 text-red-700">âš ï¸ í†µì‹  ì˜¤ë¥˜ ë°œìƒ: ì›¹í›… URLì„ í™•ì¸í•˜ê±°ë‚˜ Make ì‹œë‚˜ë¦¬ì˜¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
        } finally {
            isSending = false;
            sendButton.disabled = false;
            messagesDiv.scrollTop = messagesDiv.scrollHeight; 
        }
    }
</script>

</body>
</html>
