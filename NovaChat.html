<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/three-dots@0.3.2/dist/three-dots.min.css">
    <title>ERP-AI Ï±óÎ¥á</title>
    <!-- Tailwind CSS CDN Î°úÎìú -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        #messages {
            overflow-y: auto;
        }

        /* GPT Ïä§ÌÉÄÏùº ÏûÖÎ†•Î∞î */
        .gpt-input-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            padding: 6px 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .gpt-left-btn {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            border: none;
            background: #f3f4f6;
            color: #374151;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            padding: 0 8px;
        }

        .ai-toggle-active {
            background-color: #0284c7 !important;
            border-color: #0284c7 !important;
            color: white !important;
        }

        .gpt-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            line-height: 1.4;
            padding: 10px 10px;
            min-height: 44px;
            max-height: 120px;
            background: transparent;
            scrollbar-width: none;
        }
        .gpt-input::-webkit-scrollbar { display: none; }

        .gpt-send-btn {
            background: #4f46e5;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(79,70,229,0.4);
        }
        .gpt-send-btn:disabled {
            background: #9ca3af;
            box-shadow: none;
        }

        textarea {
            scrollbar-width: none;
            -ms-overflow-style: none;
            overflow-y: auto;
            resize: none;
        }

        .user-message {
            background-color: #4f46e5;
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 4px 10px rgba(15,23,42,0.18);
            font-size: 0.875rem;
            line-height: 1.5;
            position: relative;
        }

        .ai-message {
            background-color: #f3f4f6;
            color: #111827;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin: 10px 10px;
            max-width: 100%;
            align-self: flex-start;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Ïç∏ÎÑ§Ïùº Ïä§ÌÉÄÏùº */
        .thumb-wrap {
            position: relative;
            display: inline-block;
            min-width: 64px;
            min-height: 64px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: visible;
        }
        .thumb {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 11px;
        }
        .thumb-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        .msg-attachments {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .msg-attachments img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        #image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        #modal-img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        #modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }

        .reuse-btn {
            @apply absolute -top-2 -right-2 bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-indigo-200 cursor-pointer border border-indigo-200;
            font-size: 10px;
        }

        /* Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .stage { padding: 20px 0; display: flex; justify-content: center; }
        .dot-floating {
            position: relative;
            width: 8px; height: 8px;
            border-radius: 4px;
            background-color: #4f46e5;
            animation: dot-floating 3s infinite cubic-bezier(0.15, 0.6, 0.9, 0.1);
        }
        @keyframes dot-floating {
            0% { left: -40px; }
            50% { left: 40px; }
            100% { left: -40px; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen">

<div class="flex h-screen">
    <!-- ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î (ÌïÑÌÑ∞ ÏòÅÏó≠) -->
    <aside class="w-80 bg-white border-r flex flex-col">
        <div class="p-4 border-b">
            <h1 class="text-lg font-bold text-indigo-600">ERP-AI ÌïÑÌÑ∞</h1>
            <p class="text-xs text-gray-500 mt-1">ÏóîÏßÑ Î∞è Í≤ÄÏÉâ Ï°∞Í±¥ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">
            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI ÏóîÏßÑ ÏÑ†ÌÉù</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">
                    <label class="flex items-center space-x-2"><input type="radio" name="ai-engine" value="gemini" checked> <span>Gemini</span></label>
                    <label class="flex items-center space-x-2"><input type="radio" name="ai-engine" value="gpt"> <span>GPT</span></label>
                </div>
            </section>

            <section>
                <h2 class="text-xs font-semibold text-gray-600 mb-2">AI Î∂ÑÏÑù Î™®Îìú</h2>
                <div class="p-2 border border-gray-300 rounded-lg space-y-2">
                    <label class="flex items-center space-x-2"><input type="radio" name="ai-mode" value="erp" checked> <span>ERP-AI Î∂ÑÏÑù</span></label>
                    <label class="flex items-center space-x-2"><input type="radio" name="ai-mode" value="ai"> <span>AI Í≤ÄÏÉâ</span></label>
                </div>
            </section>

            <section id="period-section">
                <h2 class="text-xs font-semibold text-gray-600 mb-2">Í∏∞Í∞Ñ ÏÑ†ÌÉù</h2>
                <div class="space-y-2">
                    <input type="date" id="start-date" class="w-full p-2 border border-gray-300 rounded-lg">
                    <input type="date" id="end-date" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <p id="sheet-update-display" class="text-[10px] text-gray-500 mt-2 text-center"></p>
            </section>

            <section id="erp-options-section" class="space-y-4">
                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">Location</h2>
                    <div class="p-2 border border-gray-300 rounded-lg space-y-1">
                        <label class="flex items-center space-x-2 font-bold"><input type="checkbox" id="location-all"> <span>Î™®Îëê ÏÑ†ÌÉù</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="location-checkbox" value="1007" data-label="SEA"> <span>SEA</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="location-checkbox" value="1008" data-label="SEG"> <span>SEG</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="location-checkbox" value="1006" data-label="SEMA"> <span>SEMA</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="location-checkbox" value="1005" data-label="SEMS"> <span>SEMS</span></label>
                    </div>
                </div>

                <div>
                    <h2 class="text-xs font-semibold text-gray-600 mb-2">ÏóÖÏ≤¥Î™Ö/ÌíàÎ™©</h2>
                    <div class="space-y-2">
                        <input type="text" id="SupplierName" placeholder="ÏóÖÏ≤¥Î™Ö" class="w-full p-2 border border-gray-300 rounded-lg">
                        <input type="text" id="item-color-input" placeholder="ÌíàÎ™© ÏÜçÏÑ±" class="w-full p-2 border border-gray-300 rounded-lg">
                        <input type="text" id="InvoiceNo" placeholder="Invoice No" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div id="critique-btn-wrapper">
                    <button onclick="requestCritique()" class="w-full p-3 bg-green-500 text-white rounded-lg font-bold shadow-md hover:bg-green-600 transition">‚ú® Îç∞Ïù¥ÌÑ∞ Critique (Gemini)</button>
                </div>
            </section>
        </div>
    </aside>

    <!-- Ïò§Î•∏Ï™Ω: Î©îÏù∏ Ï±ÑÌåÖ ÏòÅÏó≠ -->
    <main class="flex-1 flex flex-col">
        <header class="h-14 px-6 flex items-center border-b bg-white">
            <h2 class="text-base font-semibold">ERP-AI Intelligent Chat</h2>
        </header>

        <section id="messages" class="flex-1 flex flex-col p-4 space-y-3 bg-white"></section>

        <section class="bg-white p-4">
            <div class="max-w-3xl mx-auto space-y-2">
                <div class="gpt-input-bar">
                    <button id="ai-search-toggle" class="gpt-left-btn">AIÎ™®Îìú</button>
                    <button id="attach-btn" type="button" class="p-2 text-gray-500 hover:text-indigo-600 transition" title="ÌååÏùº Ï≤®Î∂Ä">üìé</button>
                    <textarea id="user-input" placeholder="Ïó¨Í∏∞Ïóê ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî..." class="gpt-input" rows="1" oninput="autoResize(this)"></textarea>
                    <button onclick="sendMessage()" id="send-button" class="gpt-send-btn">‚û§</button>
                </div>
                <input id="file-input" type="file" accept="*/*" multiple class="hidden">
                <div id="attachment-preview" class="msg-attachments"></div>
            </div>
        </section>
    </main>
</div>

<!-- Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ -->
<div id="image-modal" onclick="this.style.display='none'">
    <span id="modal-close">&times;</span>
    <img id="modal-img" src="" alt="ÌôïÎåÄ Ïù¥ÎØ∏ÏßÄ">
</div>

<script>
const MAX_FILES = 3;
const MAX_TOTAL_BYTES = 10 * 1024 * 1024;
const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/beojnrbam68450c5366anrdb2lfdi8uq";

window.attachedImages = [];
let isSending = false;

// Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ Í∏∞Îä•
function openImageModal(src) {
    const modal = document.getElementById('image-modal');
    document.getElementById('modal-img').src = src;
    modal.style.display = "flex";
}

// Î©îÏãúÏßÄ Ïû¨ÏÇ¨Ïö©
function reuseMessage(text) {
    const input = document.getElementById("user-input");
    input.value = text;
    input.focus();
    autoResize(input);
}

function autoResize(el) {
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
}

// ÌïÑÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
function collectFilterData() {
    const start = document.getElementById("start-date").value;
    const end = document.getElementById("end-date").value;
    const locs = Array.from(document.querySelectorAll(".location-checkbox:checked")).map(cb => cb.dataset.label);
    
    return {
        startDate: start,
        endDate: end,
        location: locs.join(", ") || 'All',
        supplier: document.getElementById("SupplierName").value.trim(),
        itemAttr: document.getElementById("item-color-input").value.trim(),
        invoice: document.getElementById("InvoiceNo").value.trim()
    };
}

// Critique ÏöîÏ≤≠
function requestCritique() {
    const f = collectFilterData();
    const prompt = `ÌòÑÏû¨ ÏÑ§Ï†ïÎêú ÌïÑÌÑ∞Î•º Î∂ÑÏÑùÌïòÍ≥† Ïú†ÏùòÎØ∏Ìïú Î∂ÑÏÑù Ìè¨Ïù∏Ìä∏Î•º Ï†úÏïàÌï¥Ï§ò.\n\n[ÌòÑÏû¨ ÌïÑÌÑ∞]\nÍ∏∞Í∞Ñ: ${f.startDate} ~ ${f.endDate}\nÏßÄÏó≠: ${f.location}\nÏóÖÏ≤¥: ${f.supplier || 'ÎØ∏ÏßÄÏ†ï'}\nÏÜçÏÑ±: ${f.itemAttr || 'ÎØ∏ÏßÄÏ†ï'}\nÏÜ°Ïû•: ${f.invoice || 'ÎØ∏ÏßÄÏ†ï'}`;
    reuseMessage(prompt);
    sendMessage();
}

// ÌååÏùº Ï≤®Î∂Ä Ï≤òÎ¶¨
function addImageFiles(files) {
    const arr = Array.from(files);
    if (window.attachedImages.length + arr.length > MAX_FILES) {
        pushWarn(`ÏµúÎåÄ ${MAX_FILES}Í∞úÏùò ÌååÏùºÎßå Ï≤®Î∂ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.`);
        return;
    }
    
    arr.forEach(file => {
        if (file.size > MAX_TOTAL_BYTES) {
            pushWarn(`${file.name}Ïùò Ïö©ÎüâÏù¥ ÎÑàÎ¨¥ ÌÅΩÎãàÎã§ (ÏµúÎåÄ 10MB).`);
            return;
        }
        window.attachedImages.push(file);
    });
    renderAttachments();
}

function renderAttachments() {
    const preview = document.getElementById("attachment-preview");
    preview.innerHTML = "";
    window.attachedImages.forEach((file, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "thumb-wrap";
        
        if (file.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.className = "thumb";
            const reader = new FileReader();
            reader.onload = (e) => img.src = e.target.result;
            reader.readAsDataURL(file);
            wrap.appendChild(img);
        } else {
            wrap.innerHTML = `<div class="thumb flex items-center justify-center text-[10px] font-bold text-gray-400 bg-gray-50">${file.name.split('.').pop().toUpperCase()}</div>`;
        }
        
        const close = document.createElement("div");
        close.className = "thumb-remove";
        close.innerHTML = "√ó";
        close.onclick = () => { window.attachedImages.splice(idx, 1); renderAttachments(); };
        wrap.appendChild(close);
        preview.appendChild(wrap);
    });
}

function pushWarn(msg) {
    const messages = document.getElementById("messages");
    messages.innerHTML += `<div class="ai-message bg-yellow-50 text-yellow-700">‚ö†Ô∏è ${msg}</div>`;
    messages.scrollTop = messages.scrollHeight;
}

async function readFileAsDataURL(file) {
    return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
    });
}

// Î©îÏãúÏßÄ Ï†ÑÏÜ° Î°úÏßÅ
async function sendMessage() {
    const input = document.getElementById("user-input");
    const messages = document.getElementById("messages");
    const text = input.value.trim();
    
    if ((!text && window.attachedImages.length === 0) || isSending) return;

    isSending = true;
    document.getElementById("send-button").disabled = true;

    // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Î†åÎçîÎßÅ
    const attParts = await Promise.all(window.attachedImages.map(async f => {
        if (f.type.startsWith("image/")) {
            const b64 = await readFileAsDataURL(f);
            return `<img src="${b64}" onclick="openImageModal('${b64}')" />`;
        }
        return `<div class="p-1 bg-white/20 rounded text-[10px]">${f.name}</div>`;
    }));
    
    const safeMsg = text.replace(/'/g, "\\'");
    messages.innerHTML += `
        <div class="user-message group">
            <button class="reuse-btn" onclick="reuseMessage('${safeMsg}')">‚úèÔ∏è</button>
            <div>${text}</div>
            <div class="msg-attachments">${attParts.join("")}</div>
        </div>
    `;
    
    input.value = "";
    autoResize(input);
    messages.scrollTop = messages.scrollHeight;

    const loading = document.createElement("div");
    loading.className = "stage";
    loading.innerHTML = `<div class="dot-floating"></div>`;
    messages.appendChild(loading);

    try {
        const formData = new FormData();
        const f = collectFilterData();
        
        formData.append("prompt", text);
        formData.append("startDate", f.startDate);
        formData.append("endDate", f.endDate);
        formData.append("location", f.location);
        formData.append("supplier", f.supplier);
        formData.append("itemAttr", f.itemAttr);
        formData.append("invoice", f.invoice);
        formData.append("aiEngine", document.querySelector('input[name="ai-engine"]:checked').value);
        
        window.attachedImages.forEach((file, i) => {
            formData.append("files", file, file.name || `pasted-image-${Date.now()}.png`);
        });

        const res = await fetch(MAKE_WEBHOOK_URL, { method: "POST", body: formData });
        const resultText = await res.text();
        
        loading.remove();
        messages.innerHTML += `<div class="ai-message">ü™Ñ ${resultText}</div>`;
    } catch (err) {
        loading.remove();
        pushWarn(`ÌÜµÏã† Ïò§Î•ò: ${err.message}`);
    } finally {
        isSending = false;
        document.getElementById("send-button").disabled = false;
        window.attachedImages = [];
        renderAttachments();
        messages.scrollTop = messages.scrollHeight;
    }
}

// Ïù¥Î≤§Ìä∏ Ï¥àÍ∏∞Ìôî
document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("user-input");
    const fileInput = document.getElementById("file-input");
    
    document.getElementById("attach-btn").onclick = () => fileInput.click();
    fileInput.onchange = (e) => { addImageFiles(e.target.files); e.target.value = ""; };

    // ‚≠ê Ï∫°Ï≤ò Ïù¥ÎØ∏ÏßÄ Î∂ôÏó¨ÎÑ£Í∏∞ Î°úÏßÅ Í∞ïÌôî
    input.addEventListener("paste", (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        const capturedFiles = [];
        for (let i = 0; i < items.length; i++) {
            if (items[i].kind === 'file') {
                const file = items[i].getAsFile();
                if (file) capturedFiles.push(file);
            }
        }
        if (capturedFiles.length > 0) {
            addImageFiles(capturedFiles);
        }
    });

    input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // ÏóîÏßÑ Î≥ÄÍ≤ΩÏóê Îî∞Î•∏ Critique Î≤ÑÌäº Í∞ÄÏãúÏÑ±
    const updateVisibility = () => {
        const isGemini = document.querySelector('input[name="ai-engine"]:checked').value === 'gemini';
        document.getElementById('critique-btn-wrapper').style.display = isGemini ? 'block' : 'none';
    };
    document.querySelectorAll('input[name="ai-engine"]').forEach(r => r.onchange = updateVisibility);
    updateVisibility();
});
</script>
</body>
</html>
